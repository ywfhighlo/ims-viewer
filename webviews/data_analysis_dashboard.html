<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†æä»ªè¡¨æ¿</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        
        /* å·¥å…·æ  */
        .toolbar { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .toolbar-row { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .date-group { display: flex; gap: 15px; align-items: center; }
        .date-group label { font-weight: 500; color: #555; }
        .date-group input { padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        
        /* å¡ç‰‡ç½‘æ ¼ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #007bff; }
        .metric-card h3 { color: #495057; font-size: 1.1em; margin-bottom: 15px; }
        .metric-value { font-size: 2.5em; font-weight: bold; color: #007bff; margin-bottom: 5px; }
        .metric-label { color: #6c757d; font-size: 0.9em; }
        .metric-change { font-size: 0.85em; margin-top: 10px; }
        .metric-change.positive { color: #28a745; }
        .metric-change.negative { color: #dc3545; }
        
        /* åˆ†æé¢æ¿ */
        .analysis-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .panel { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .panel-header { background: #f8f9fa; padding: 20px; border-bottom: 1px solid #e9ecef; }
        .panel-header h3 { color: #495057; font-size: 1.2em; }
        .panel-content { padding: 25px; }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-container { height: 300px; position: relative; }
        .chart-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d; font-size: 1.1em; background: #f8f9fa; border-radius: 8px; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
        .data-table th { background: #f8f9fa; font-weight: 600; color: #495057; }
        .data-table tbody tr:hover { background: #f8f9fa; }
        
        /* æ ‡ç­¾é¡µ */
        .analysis-tabs { display: flex; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; padding: 4px; }
        .analysis-tab { flex: 1; padding: 12px 20px; background: transparent; border: none; cursor: pointer; font-size: 14px; font-weight: 500; border-radius: 6px; transition: all 0.3s ease; }
        .analysis-tab.active { background: white; color: #007bff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .loading-content { background: white; padding: 30px; border-radius: 12px; text-align: center; min-width: 320px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* å“åº”å¼è®¾è®¡ - æ”¹è¿›ç‰ˆ */
        @media (max-width: 1200px) {
            .container { padding: 15px; }
            .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
            .analysis-panels { gap: 15px; }
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .header p { font-size: 1em; }
            .analysis-panels { grid-template-columns: 1fr; }
            .toolbar-row { flex-direction: column; align-items: stretch; gap: 15px; }
            .date-group { flex-wrap: wrap; gap: 10px; }
            .date-group input { width: 100%; max-width: 200px; }
            .btn { width: 100%; }
            .chart-container { height: 250px; }
            .metric-card { padding: 20px; }
            .metric-value { font-size: 2em; }
            .panel-content { padding: 20px; }
            .analysis-tab { padding: 10px 15px; font-size: 13px; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 10px; }
            .header { padding: 20px; margin-bottom: 20px; }
            .header h1 { font-size: 1.8em; }
            .dashboard-grid { grid-template-columns: 1fr; gap: 10px; }
            .chart-container { height: 200px; }
            .metric-card { padding: 15px; }
            .metric-value { font-size: 1.8em; }
            .data-table { font-size: 12px; }
            .data-table th, .data-table td { padding: 8px; }
        }
        
        /* å›¾è¡¨äº¤äº’å¢å¼º */
        .chart-container:hover { transform: translateY(-2px); transition: transform 0.3s ease; }
        .chart-container canvas { cursor: crosshair; }
        
        /* åŠ è½½åŠ¨ç”»å¢å¼º */
        .loading-spinner {
            background: conic-gradient(from 0deg, #007bff, #28a745, #ffc107, #dc3545, #007bff);
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        
        /* å·¥å…·æç¤ºå¢å¼º */
        .enhanced-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        /* çŠ¶æ€é¢œè‰² */
        .status-high { color: #28a745; font-weight: bold; }
        .status-medium { color: #ffc107; font-weight: bold; }
        .status-low { color: #dc3545; font-weight: bold; }
        
        /* è¿›åº¦æ¡ */
        .progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: #007bff; transition: width 0.3s ease; }
        
        /* é”™è¯¯å’ŒæˆåŠŸæ¶ˆæ¯ */
        .error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #dc3545; }
        .success-message { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #28a745; }
        .info-message { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #17a2b8; }
        
        /* å·¥å…·æç¤º */
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 12px; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ•°æ®åˆ†æä»ªè¡¨æ¿</h1>
            <p>å®æ—¶ä¸šåŠ¡æ´å¯Ÿ | æ™ºèƒ½åˆ†æ | æ•°æ®é©±åŠ¨å†³ç­–</p>
        </div>

        <!-- å·¥å…·æ  -->
        <div class="toolbar">
            <div class="toolbar-row">
                <div class="date-group">
                    <label for="start-date">å¼€å§‹æ—¥æœŸï¼š</label>
                    <input type="date" id="start-date" name="start_date">
                    <label for="end-date">ç»“æŸæ—¥æœŸï¼š</label>
                    <input type="date" id="end-date" name="end_date">
                </div>
                <button class="btn btn-primary" onclick="refreshDashboard()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button class="btn btn-secondary" onclick="showExportDialog()">ğŸ“ å¯¼å‡ºæŠ¥å‘Š</button>
            </div>
        </div>

        <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
        <div id="metrics-grid" class="dashboard-grid">
            <!-- åŠ¨æ€ç”Ÿæˆçš„æŒ‡æ ‡å¡ç‰‡ -->
        </div>

        <!-- åˆ†æé¢æ¿ -->
        <div class="analysis-panels">
            <!-- é”€å”®è¶‹åŠ¿åˆ†æ -->
            <div class="panel">
                <div class="panel-header">
                    <h3>ğŸ“ˆ é”€å”®è¶‹åŠ¿åˆ†æ</h3>
                </div>
                <div class="panel-content">
                    <div class="analysis-tabs">
                        <button class="analysis-tab active" onclick="showSalesTrend('month')">æœˆåº¦è¶‹åŠ¿</button>
                        <button class="analysis-tab" onclick="showSalesTrend('quarter')">å­£åº¦è¶‹åŠ¿</button>
                        <button class="analysis-tab" onclick="showSalesTrend('product')">äº§å“åˆ†æ</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- å®¢æˆ·ä»·å€¼åˆ†æ -->
            <div class="panel">
                <div class="panel-header">
                    <h3>ğŸ‘¥ å®¢æˆ·ä»·å€¼åˆ†æ (RFM)</h3>
                </div>
                <div class="panel-content">
                    <div id="customer-analysis" class="tab-content active">
                        <div class="chart-container">
                            <canvas id="customerValueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†åˆ†ææ ‡ç­¾é¡µ -->
        <div class="panel">
            <div class="panel-header">
                <h3>ğŸ” è¯¦ç»†åˆ†æ</h3>
            </div>
            <div class="panel-content">
                <div class="analysis-tabs">
                    <button class="analysis-tab active" onclick="showAnalysisTab('inventory')">åº“å­˜åˆ†æ</button>
                    <button class="analysis-tab" onclick="showAnalysisTab('customer')">å®¢æˆ·åˆ†æ</button>
                    <button class="analysis-tab" onclick="showAnalysisTab('purchase')">é‡‡è´­åˆ†æ</button>
                    <button class="analysis-tab" onclick="showAnalysisTab('comparison')">å¯¹æ¯”åˆ†æ</button>
                </div>

                <!-- åº“å­˜åˆ†æ -->
                <div id="inventory-analysis" class="tab-content active">
                    <h4>ğŸ“¦ åº“å­˜å‘¨è½¬åˆ†æ</h4>
                    <div id="inventory-summary"></div>
                    <div class="chart-container">
                        <canvas id="inventoryChart"></canvas>
                    </div>
                    <div id="dead-stock-table"></div>
                </div>

                <!-- å®¢æˆ·åˆ†æ -->
                <div id="customer-detailed-analysis" class="tab-content">
                    <h4>ğŸ‘¤ å®¢æˆ·è¯¦ç»†åˆ†æ</h4>
                    <div id="customer-summary"></div>
                    <div id="customer-table"></div>
                </div>

                <!-- é‡‡è´­åˆ†æ -->
                <div id="purchase-analysis" class="tab-content">
                    <h4>ğŸ›’ é‡‡è´­è¶‹åŠ¿åˆ†æ</h4>
                    <div class="analysis-tabs">
                        <button class="analysis-tab active" onclick="showPurchaseTrend('supplier')">ä¾›åº”å•†åˆ†æ</button>
                        <button class="analysis-tab" onclick="showPurchaseTrend('material')">ç‰©æ–™åˆ†æ</button>
                        <button class="analysis-tab" onclick="showPurchaseTrend('month')">æœˆåº¦è¶‹åŠ¿</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="purchaseTrendChart"></canvas>
                    </div>
                </div>

                <!-- å¯¹æ¯”åˆ†æ -->
                <div id="comparison-analysis" class="tab-content">
                    <h4>âš–ï¸ å¤šç»´åº¦å¯¹æ¯”åˆ†æ</h4>
                    <div class="toolbar-row" style="margin-bottom: 20px;">
                        <select id="comparison-metrics" multiple style="width: 200px; height: 80px;">
                            <option value="total_sales">æ€»é”€å”®é¢</option>
                            <option value="sales_count">é”€å”®ç¬”æ•°</option>
                            <option value="total_purchases">æ€»é‡‡è´­é¢</option>
                            <option value="purchase_count">é‡‡è´­ç¬”æ•°</option>
                        </select>
                        <select id="comparison-dimensions" multiple style="width: 200px; height: 80px;">
                            <option value="month">æœˆä»½</option>
                            <option value="product">äº§å“</option>
                            <option value="customer">å®¢æˆ·</option>
                            <option value="supplier">ä¾›åº”å•†</option>
                        </select>
                        <button class="btn btn-primary" onclick="generateComparison()">ç”Ÿæˆå¯¹æ¯”</button>
                    </div>
                    <div id="comparison-results"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºå¯¹è¯æ¡† -->
    <div id="exportDialog" class="loading-overlay" style="display: none;">
        <div class="loading-content" style="min-width: 500px; max-width: 600px;">
            <h3>ğŸ“ å¯¼å‡ºæ•°æ®åˆ†ææŠ¥å‘Š</h3>
            <div style="margin: 20px 0; text-align: left;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¯¼å‡ºæ ¼å¼ï¼š</label>
                    <select id="exportFormat" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="json">JSON æ ¼å¼</option>
                        <option value="csv">CSV æ ¼å¼</option>
                        <option value="excel">Excel æ ¼å¼ (é¢„ç•™)</option>
                        <option value="pdf">PDF æ ¼å¼ (é¢„ç•™)</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¯¼å‡ºå†…å®¹ï¼š</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="exportOverview" checked> ä¸šåŠ¡æ¦‚è§ˆ
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="exportSalesTrend" checked> é”€å”®è¶‹åŠ¿
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="exportCustomerAnalysis" checked> å®¢æˆ·åˆ†æ
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="exportInventoryAnalysis" checked> åº“å­˜åˆ†æ
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="exportComparisonAnalysis"> å¯¹æ¯”åˆ†æ
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="includeCharts" checked> åŒ…å«å›¾è¡¨æ•°æ®
                        </label>
                    </div>
                </div>
                
                <div id="exportStatus" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;">
                    <div id="exportProgress" style="margin-bottom: 10px;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="exportProgressBar" style="width: 0%;"></div>
                        </div>
                        <div id="exportProgressText" style="font-size: 12px; color: #666; text-align: center;">å‡†å¤‡å¯¼å‡º...</div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeExportDialog()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="startExport()">å¼€å§‹å¯¼å‡º</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é®ç½©å±‚ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">æ­£åœ¨åŠ è½½æ•°æ®...</h3>
            <p id="loadingMessage">è¯·ç¨å€™ï¼Œæ­£åœ¨åˆ†ææ‚¨çš„ä¸šåŠ¡æ•°æ®...</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const vscode = acquireVsCodeApi();
        let dashboardData = null;
        let salesTrendChart = null;
        let customerValueChart = null;
        let inventoryChart = null;
        let purchaseTrendChart = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæœ€è¿‘3ä¸ªæœˆï¼‰
            const today = new Date();
            const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            
            document.getElementById('start-date').value = threeMonthsAgo.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];

            // åŠ è½½åˆå§‹æ•°æ®
            refreshDashboard();
        });

        // ç›‘å¬æ¥è‡ªåç«¯çš„æ¶ˆæ¯
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.command) {
                case 'dashboardData':
                    handleDashboardData(message.data);
                    break;
                case 'salesTrendData':
                    handleSalesTrendData(message.data, message.dimension);
                    break;
                case 'customerAnalysisData':
                    handleCustomerAnalysisData(message.data);
                    break;
                case 'inventoryAnalysisData':
                    handleInventoryAnalysisData(message.data);
                    break;
                case 'comparisonAnalysisData':
                    handleComparisonAnalysisData(message.data);
                    break;
                case 'exportStatus':
                    handleExportStatus(message);
                    break;
                case 'exportProgress':
                    handleExportProgress(message);
                    break;
                case 'exportComplete':
                    handleExportComplete(message);
                    break;
                case 'error':
                    handleError(message.error || message.message);
                    break;
            }
        });

        // åˆ·æ–°ä»ªè¡¨æ¿
        function refreshDashboard() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                showError('è¯·é€‰æ‹©åˆ†ææ—¥æœŸèŒƒå›´');
                return;
            }

            showLoading('æ­£åœ¨åŠ è½½ä»ªè¡¨æ¿æ•°æ®...');

            vscode.postMessage({
                command: 'getDashboardData',
                params: {
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ - å¢å¼ºç‰ˆ
        function showLoading(title, message = 'è¯·ç¨å€™ï¼Œæ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...', showProgress = false) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingTitle = document.getElementById('loadingTitle');
            const loadingMessage = document.getElementById('loadingMessage');
            
            // æ›´æ–°åŠ è½½ä¿¡æ¯
            loadingTitle.textContent = title;
            loadingMessage.textContent = message;
            
            // æ˜¾ç¤ºåŠ è½½é®ç½©
            loadingOverlay.style.display = 'flex';
            
            // æ·»åŠ æ·¡å…¥åŠ¨ç”»
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                loadingOverlay.style.opacity = '1';
            }, 10);
            
            // è®°å½•åŠ è½½å¼€å§‹æ—¶é—´
            loadingOverlay.dataset.startTime = Date.now();
            
            // å¦‚æœéœ€è¦æ˜¾ç¤ºè¿›åº¦ï¼Œæ·»åŠ è¿›åº¦æ¡
            if (showProgress) {
                addProgressBar();
            }
            
            console.log(`ğŸ”„ å¼€å§‹åŠ è½½: ${title}`);
        }

        // éšè—åŠ è½½çŠ¶æ€ - å¢å¼ºç‰ˆ
        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            if (loadingOverlay.style.display === 'none') {
                return; // å·²ç»éšè—ï¼Œé¿å…é‡å¤æ“ä½œ
            }
            
            // è®¡ç®—åŠ è½½æ—¶é—´
            const startTime = parseInt(loadingOverlay.dataset.startTime || Date.now());
            const loadTime = Date.now() - startTime;
            
            // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
            loadingOverlay.style.opacity = '0';
            
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                loadingOverlay.style.opacity = '1'; // é‡ç½®é€æ˜åº¦
                
                // ç§»é™¤è¿›åº¦æ¡
                removeProgressBar();
                
                console.log(`âœ… åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${loadTime}ms`);
            }, 200);
        }

        // æ·»åŠ è¿›åº¦æ¡
        function addProgressBar() {
            const loadingContent = document.querySelector('.loading-content');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¿›åº¦æ¡
            if (loadingContent.querySelector('.progress-bar')) {
                return;
            }
            
            const progressHtml = `
                <div class="progress-bar" style="margin-top: 20px;">
                    <div class="progress-fill" id="loadingProgress" style="width: 0%;"></div>
                </div>
                <div id="progressText" style="font-size: 12px; color: #666; margin-top: 8px;">æ­£åœ¨åˆå§‹åŒ–...</div>
            `;
            
            loadingContent.insertAdjacentHTML('beforeend', progressHtml);
            
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            simulateProgress();
        }

        // ç§»é™¤è¿›åº¦æ¡
        function removeProgressBar() {
            const progressBar = document.querySelector('.loading-content .progress-bar');
            const progressText = document.getElementById('progressText');
            
            if (progressBar) progressBar.remove();
            if (progressText) progressText.remove();
        }

        // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
        function simulateProgress() {
            const progressFill = document.getElementById('loadingProgress');
            const progressText = document.getElementById('progressText');
            
            if (!progressFill || !progressText) return;
            
            let progress = 0;
            const steps = [
                { progress: 20, text: 'è¿æ¥æ•°æ®åº“...' },
                { progress: 40, text: 'æŸ¥è¯¢æ•°æ®...' },
                { progress: 60, text: 'å¤„ç†æ•°æ®...' },
                { progress: 80, text: 'ç”Ÿæˆå›¾è¡¨...' },
                { progress: 95, text: 'å®Œæˆå¤„ç†...' }
            ];
            
            let stepIndex = 0;
            const interval = setInterval(() => {
                if (stepIndex < steps.length) {
                    const step = steps[stepIndex];
                    progressFill.style.width = step.progress + '%';
                    progressText.textContent = step.text;
                    stepIndex++;
                } else {
                    clearInterval(interval);
                }
            }, 500);
            
            // ä¿å­˜interval IDä»¥ä¾¿æ¸…ç†
            progressFill.dataset.intervalId = interval;
        }

        // æ›´æ–°åŠ è½½çŠ¶æ€
        function updateLoadingStatus(message, progress = null) {
            const loadingMessage = document.getElementById('loadingMessage');
            const progressFill = document.getElementById('loadingProgress');
            const progressText = document.getElementById('progressText');
            
            if (loadingMessage) {
                loadingMessage.textContent = message;
            }
            
            if (progress !== null && progressFill) {
                progressFill.style.width = progress + '%';
            }
            
            if (progressText) {
                progressText.textContent = message;
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            hideLoading();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `âŒ ${message}`;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.dashboard-grid'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `âœ… ${message}`;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.dashboard-grid'));
            setTimeout(() => successDiv.remove(), 5000);
        }

        // æ˜¾ç¤ºå¯¼å‡ºå¯¹è¯æ¡†
        function showExportDialog() {
            const exportDialog = document.getElementById('exportDialog');
            exportDialog.style.display = 'flex';
            
            // é‡ç½®è¡¨å•çŠ¶æ€
            document.getElementById('exportFormat').value = 'json';
            document.getElementById('exportOverview').checked = true;
            document.getElementById('exportSalesTrend').checked = true;
            document.getElementById('exportCustomerAnalysis').checked = true;
            document.getElementById('exportInventoryAnalysis').checked = true;
            document.getElementById('exportComparisonAnalysis').checked = false;
            document.getElementById('includeCharts').checked = true;
            
            // éšè—çŠ¶æ€åŒºåŸŸ
            document.getElementById('exportStatus').style.display = 'none';
            
            console.log('ğŸ“ æ˜¾ç¤ºå¯¼å‡ºå¯¹è¯æ¡†');
        }

        // å…³é—­å¯¼å‡ºå¯¹è¯æ¡†
        function closeExportDialog() {
            const exportDialog = document.getElementById('exportDialog');
            exportDialog.style.display = 'none';
            console.log('âŒ å…³é—­å¯¼å‡ºå¯¹è¯æ¡†');
        }

        // å¼€å§‹å¯¼å‡º
        function startExport() {
            // è·å–å¯¼å‡ºå‚æ•°
            const exportFormat = document.getElementById('exportFormat').value;
            const includeCharts = document.getElementById('includeCharts').checked;
            
            // æ”¶é›†é€‰ä¸­çš„å¯¼å‡ºéƒ¨åˆ†
            const exportSections = [];
            if (document.getElementById('exportOverview').checked) {
                exportSections.push('overview');
            }
            if (document.getElementById('exportSalesTrend').checked) {
                exportSections.push('sales_trend');
            }
            if (document.getElementById('exportCustomerAnalysis').checked) {
                exportSections.push('customer_analysis');
            }
            if (document.getElementById('exportInventoryAnalysis').checked) {
                exportSections.push('inventory_analysis');
            }
            if (document.getElementById('exportComparisonAnalysis').checked) {
                exportSections.push('comparison_analysis');
            }
            
            // éªŒè¯é€‰æ‹©
            if (exportSections.length === 0) {
                showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¯¼å‡ºå†…å®¹');
                return;
            }
            
            // è·å–æ—¥æœŸèŒƒå›´
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                showError('è¯·å…ˆé€‰æ‹©åˆ†ææ—¥æœŸèŒƒå›´');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºçŠ¶æ€
            showExportStatus();
            
            // æ„å»ºå¯¼å‡ºå‚æ•°
            const exportParams = {
                export_format: exportFormat,
                export_sections: exportSections,
                include_charts: includeCharts,
                date_range: {
                    start_date: startDate,
                    end_date: endDate
                }
            };
            
            console.log('ğŸš€ å¼€å§‹å¯¼å‡ºæ•°æ®', exportParams);
            
            // å‘é€å¯¼å‡ºè¯·æ±‚
            vscode.postMessage({
                command: 'exportDashboardData',
                params: exportParams
            });
        }

        // æ˜¾ç¤ºå¯¼å‡ºçŠ¶æ€
        function showExportStatus() {
            const exportStatus = document.getElementById('exportStatus');
            const exportProgressBar = document.getElementById('exportProgressBar');
            const exportProgressText = document.getElementById('exportProgressText');
            
            exportStatus.style.display = 'block';
            exportProgressBar.style.width = '0%';
            exportProgressText.textContent = 'å‡†å¤‡å¯¼å‡º...';
            
            // æ¨¡æ‹Ÿå¯¼å‡ºè¿›åº¦
            simulateExportProgress();
        }

        // æ¨¡æ‹Ÿå¯¼å‡ºè¿›åº¦
        function simulateExportProgress() {
            const exportProgressBar = document.getElementById('exportProgressBar');
            const exportProgressText = document.getElementById('exportProgressText');
            
            if (!exportProgressBar || !exportProgressText) return;
            
            const steps = [
                { progress: 10, text: 'åˆå§‹åŒ–å¯¼å‡º...' },
                { progress: 25, text: 'æ”¶é›†æ¦‚è§ˆæ•°æ®...' },
                { progress: 40, text: 'æ”¶é›†é”€å”®è¶‹åŠ¿æ•°æ®...' },
                { progress: 55, text: 'æ”¶é›†å®¢æˆ·åˆ†ææ•°æ®...' },
                { progress: 70, text: 'æ”¶é›†åº“å­˜åˆ†ææ•°æ®...' },
                { progress: 85, text: 'æ ¼å¼åŒ–å¯¼å‡ºæ•°æ®...' },
                { progress: 95, text: 'å‡†å¤‡ä¸‹è½½...' }
            ];
            
            let stepIndex = 0;
            const interval = setInterval(() => {
                if (stepIndex < steps.length) {
                    const step = steps[stepIndex];
                    exportProgressBar.style.width = step.progress + '%';
                    exportProgressText.textContent = step.text;
                    stepIndex++;
                } else {
                    clearInterval(interval);
                }
            }, 300);
            
            // ä¿å­˜interval IDä»¥ä¾¿æ¸…ç†
            exportProgressBar.dataset.intervalId = interval;
        }

        // å¤„ç†å¯¼å‡ºçŠ¶æ€æ¶ˆæ¯
        function handleExportStatus(message) {
            console.log('ğŸ“Š å¯¼å‡ºçŠ¶æ€æ›´æ–°', message);
            
            if (message.status === 'started') {
                updateExportProgress(5, message.message || 'å¼€å§‹å¯¼å‡º...');
            }
        }

        // å¤„ç†å¯¼å‡ºè¿›åº¦æ¶ˆæ¯
        function handleExportProgress(message) {
            console.log('ğŸ“ˆ å¯¼å‡ºè¿›åº¦æ›´æ–°', message);
            
            const progress = message.progress || 0;
            const progressMessage = message.message || 'æ­£åœ¨å¤„ç†...';
            
            updateExportProgress(progress, progressMessage);
        }

        // æ›´æ–°å¯¼å‡ºè¿›åº¦
        function updateExportProgress(progress, message) {
            const exportProgressBar = document.getElementById('exportProgressBar');
            const exportProgressText = document.getElementById('exportProgressText');
            
            if (exportProgressBar) {
                exportProgressBar.style.width = progress + '%';
            }
            
            if (exportProgressText) {
                exportProgressText.textContent = message;
            }
        }

        // å¤„ç†å¯¼å‡ºå®Œæˆ
        function handleExportComplete(result) {
            console.log('âœ… å¯¼å‡ºå®Œæˆ', result);
            
            if (result.success) {
                // æ›´æ–°è¿›åº¦ä¸º100%
                updateExportProgress(100, 'å¯¼å‡ºå®Œæˆï¼');
                
                // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                const downloadInfo = result.download_info || {};
                const filename = downloadInfo.filename || 'dashboard_export.json';
                const sizeMB = downloadInfo.size_mb || 0;
                
                setTimeout(() => {
                    closeExportDialog();
                    showSuccess(`å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶: ${filename}ï¼Œå¤§å°: ${sizeMB}MB`);
                    
                    // è§¦å‘æ–‡ä»¶ä¸‹è½½
                    downloadExportedData(result.export_data, filename, downloadInfo.content_type);
                }, 1000);
                
            } else {
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errorMessage = result.error?.message || 'å¯¼å‡ºå¤±è´¥';
                updateExportProgress(0, `å¯¼å‡ºå¤±è´¥: ${errorMessage}`);
                
                setTimeout(() => {
                    closeExportDialog();
                    showError(`å¯¼å‡ºå¤±è´¥: ${errorMessage}`);
                }, 2000);
            }
        }

        // ä¸‹è½½å¯¼å‡ºçš„æ•°æ®
        function downloadExportedData(data, filename, contentType) {
            try {
                let downloadData;
                let downloadFilename = filename;
                
                // æ ¹æ®æ•°æ®ç±»å‹å¤„ç†ä¸‹è½½
                if (typeof data === 'object') {
                    downloadData = JSON.stringify(data, null, 2);
                    if (!downloadFilename.endsWith('.json')) {
                        downloadFilename = downloadFilename.replace(/\.[^.]+$/, '.json');
                    }
                } else {
                    downloadData = data;
                }
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([downloadData], { 
                    type: contentType || 'application/json' 
                });
                const url = URL.createObjectURL(blob);
                
                // åˆ›å»ºä¸´æ—¶ä¸‹è½½é“¾æ¥
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = downloadFilename;
                downloadLink.style.display = 'none';
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // æ¸…ç†URLå¯¹è±¡
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                console.log(`ğŸ“¥ æ–‡ä»¶ä¸‹è½½è§¦å‘: ${downloadFilename}`);
                
            } catch (error) {
                console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
                showError('æ–‡ä»¶ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // å¤„ç†å¯¼å‡ºé”™è¯¯
        function handleExportError(error) {
            console.error('âŒ å¯¼å‡ºé”™è¯¯', error);
            
            updateExportProgress(0, 'å¯¼å‡ºå¤±è´¥');
            
            setTimeout(() => {
                closeExportDialog();
                showError('å¯¼å‡ºå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }, 1000);
        },
                params: exportParams
            });
        }

        // æ˜¾ç¤ºå¯¼å‡ºçŠ¶æ€
        function showExportStatus() {
            const exportStatus = document.getElementById('exportStatus');
            const exportProgressBar = document.getElementById('exportProgressBar');
            const exportProgressText = document.getElementById('exportProgressText');
            
            exportStatus.style.display = 'block';
            exportProgressBar.style.width = '0%';
            exportProgressText.textContent = 'å‡†å¤‡å¯¼å‡º...';
            
            // æ¨¡æ‹Ÿå¯¼å‡ºè¿›åº¦
            simulateExportProgress();
        }

        // æ¨¡æ‹Ÿå¯¼å‡ºè¿›åº¦
        function simulateExportProgress() {
            const exportProgressBar = document.getElementById('exportProgressBar');
            const exportProgressText = document.getElementById('exportProgressText');
            
            if (!exportProgressBar || !exportProgressText) return;
            
            const steps = [
                { progress: 10, text: 'åˆå§‹åŒ–å¯¼å‡º...' },
                { progress: 25, text: 'æ”¶é›†æ¦‚è§ˆæ•°æ®...' },
                { progress: 40, text: 'æ”¶é›†é”€å”®è¶‹åŠ¿æ•°æ®...' },
                { progress: 55, text: 'æ”¶é›†å®¢æˆ·åˆ†ææ•°æ®...' },
                { progress: 70, text: 'æ”¶é›†åº“å­˜åˆ†ææ•°æ®...' },
                { progress: 85, text: 'æ ¼å¼åŒ–å¯¼å‡ºæ•°æ®...' },
                { progress: 95, text: 'å‡†å¤‡ä¸‹è½½...' }
            ];
            
            let stepIndex = 0;
            const interval = setInterval(() => {
                if (stepIndex < steps.length) {
                    const step = steps[stepIndex];
                    exportProgressBar.style.width = step.progress + '%';
                    exportProgressText.textContent = step.text;
                    stepIndex++;
                } else {
                    clearInterval(interval);
                }
            }, 300);
            
            // ä¿å­˜interval IDä»¥ä¾¿æ¸…ç†
            exportProgressBar.dataset.intervalId = interval;
        }

        // æ›´æ–°å¯¼å‡ºè¿›åº¦
        function updateExportProgress(progress, message) {
            const exportProgressBar = document.getElementById('exportProgressBar');
            const exportProgressText = document.getElementById('exportProgressText');
            
            if (exportProgressBar) {
                exportProgressBar.style.width = progress + '%';
            }
            
            if (exportProgressText) {
                exportProgressText.textContent = message;
            }
        }

        // å¤„ç†å¯¼å‡ºå®Œæˆ
        function handleExportComplete(result) {
            console.log('âœ… å¯¼å‡ºå®Œæˆ', result);
            
            if (result.success) {
                // æ›´æ–°è¿›åº¦ä¸º100%
                updateExportProgress(100, 'å¯¼å‡ºå®Œæˆï¼');
                
                // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                const downloadInfo = result.download_info || {};
                const filename = downloadInfo.filename || 'dashboard_export.json';
                const sizeMB = downloadInfo.size_mb || 0;
                
                setTimeout(() => {
                    closeExportDialog();
                    showSuccess(`å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶: ${filename}ï¼Œå¤§å°: ${sizeMB}MB`);
                    
                    // è§¦å‘æ–‡ä»¶ä¸‹è½½
                    downloadExportedData(result.export_data, filename, downloadInfo.content_type);
                }, 1000);
                
            } else {
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errorMessage = result.error?.message || 'å¯¼å‡ºå¤±è´¥';
                updateExportProgress(0, `å¯¼å‡ºå¤±è´¥: ${errorMessage}`);
                
                setTimeout(() => {
                    closeExportDialog();
                    showError(`å¯¼å‡ºå¤±è´¥: ${errorMessage}`);
                }, 2000);
            }
        }

        // ä¸‹è½½å¯¼å‡ºçš„æ•°æ®
        function downloadExportedData(data, filename, contentType) {
            try {
                let downloadData;
                let downloadFilename = filename;
                
                // æ ¹æ®æ•°æ®ç±»å‹å¤„ç†ä¸‹è½½
                if (typeof data === 'object') {
                    downloadData = JSON.stringify(data, null, 2);
                    if (!downloadFilename.endsWith('.json')) {
                        downloadFilename = downloadFilename.replace(/\.[^.]+$/, '.json');
                    }
                } else {
                    downloadData = data;
                }
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([downloadData], { 
                    type: contentType || 'application/json' 
                });
                const url = URL.createObjectURL(blob);
                
                // åˆ›å»ºä¸´æ—¶ä¸‹è½½é“¾æ¥
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = downloadFilename;
                downloadLink.style.display = 'none';
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // æ¸…ç†URLå¯¹è±¡
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                console.log(`ğŸ“¥ æ–‡ä»¶ä¸‹è½½è§¦å‘: ${downloadFilename}`);
                
            } catch (error) {
                console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
                showError('æ–‡ä»¶ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // å¤„ç†å¯¼å‡ºé”™è¯¯
        function handleExportError(error) {
            console.error('âŒ å¯¼å‡ºé”™è¯¯', error);
            
            updateExportProgress(0, 'å¯¼å‡ºå¤±è´¥');
            
            setTimeout(() => {
                closeExportDialog();
                showError('å¯¼å‡ºå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }, 1000);
        }

        // ç”Ÿæˆå…³é”®æŒ‡æ ‡å¡ç‰‡
        function generateMetricCards(data) {
            const metricsGrid = document.getElementById('metrics-grid');
            const overview = data.overview || {};

            const metrics = [
                {
                    title: 'æ€»é”€å”®é¢',
                    value: formatCurrency(overview.total_sales || 0),
                    label: 'æœ¬æœŸé”€å”®æ€»é¢',
                    icon: 'ğŸ’°'
                },
                {
                    title: 'æ€»è®¢å•æ•°',
                    value: (overview.total_sales_count || 0).toLocaleString(),
                    label: 'æœ¬æœŸè®¢å•æ€»æ•°',
                    icon: 'ğŸ“‹'
                },
                {
                    title: 'æ´»è·ƒå®¢æˆ·',
                    value: (overview.active_customers || 0).toLocaleString(),
                    label: `å®¢æˆ·æ´»è·ƒåº¦ ${((overview.customer_activity_rate || 0)).toFixed(1)}%`,
                    icon: 'ğŸ‘¥'
                },
                {
                    title: 'åº“å­˜ä»·å€¼',
                    value: formatCurrency(overview.total_inventory_value || 0),
                    label: `ä½åº“å­˜é¢„è­¦ ${overview.low_stock_items || 0} é¡¹`,
                    icon: 'ğŸ“¦'
                },
                {
                    title: 'å¹³å‡è®¢å•ä»·å€¼',
                    value: formatCurrency(overview.avg_order_value || 0),
                    label: 'æ¯å•å¹³å‡é‡‘é¢',
                    icon: 'ğŸ’³'
                },
                {
                    title: 'æ¯›åˆ©æ¶¦',
                    value: formatCurrency(overview.gross_margin || 0),
                    label: 'é”€å”®é¢ - é‡‡è´­é¢',
                    icon: 'ğŸ“ˆ'
                }
            ];

            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <h3>${metric.icon} ${metric.title}</h3>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºé”€å”®è¶‹åŠ¿
        function showSalesTrend(dimension) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            showLoading('æ­£åœ¨åŠ è½½é”€å”®è¶‹åŠ¿æ•°æ®...');

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            vscode.postMessage({
                command: 'getSalesTrend',
                params: {
                    dimension: dimension,
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // åˆ›å»ºé”€å”®è¶‹åŠ¿å›¾è¡¨ - æ”¹è¿›ç‰ˆ
        function createSalesTrendChart(data, dimension) {
            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            
            if (salesTrendChart) {
                salesTrendChart.destroy();
            }

            // æ•°æ®éªŒè¯å’Œå¤„ç†
            if (!data || !Array.isArray(data) || data.length === 0) {
                const chartContainer = ctx.canvas.parentElement;
                chartContainer.innerHTML = '<div class="chart-placeholder">ğŸ“Š æš‚æ— é”€å”®è¶‹åŠ¿æ•°æ®</div>';
                return;
            }

            let labels, values, orderCounts = [];
            
            // æ ¹æ®ç»´åº¦å¤„ç†æ•°æ®
            if (dimension === 'month' || dimension === 'quarter') {
                // æŒ‰æ—¶é—´æ’åº
                const sortedData = data.sort((a, b) => {
                    const dateA = new Date(a.month || a.quarter || a._id);
                    const dateB = new Date(b.month || b.quarter || b._id);
                    return dateA - dateB;
                });
                
                labels = sortedData.map(item => {
                    const dateStr = item.month || item.quarter || item._id;
                    // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                    if (dimension === 'month') {
                        return new Date(dateStr + '-01').toLocaleDateString('zh-CN', { year: 'numeric', month: 'short' });
                    }
                    return dateStr;
                });
                values = sortedData.map(item => item.total_sales || 0);
                orderCounts = sortedData.map(item => item.sales_count || item.order_count || 0);
            } else if (dimension === 'product') {
                // æŒ‰é”€å”®é¢æ’åºï¼Œå–å‰15ä¸ª
                const sortedData = data
                    .sort((a, b) => (b.total_sales || 0) - (a.total_sales || 0))
                    .slice(0, 15);
                
                labels = sortedData.map(item => {
                    const name = item._id || item.product_name || 'æœªçŸ¥äº§å“';
                    // æˆªæ–­è¿‡é•¿çš„äº§å“åç§°
                    return name.length > 12 ? name.substring(0, 12) + '...' : name;
                });
                values = sortedData.map(item => item.total_sales || 0);
                orderCounts = sortedData.map(item => item.sales_count || item.order_count || 0);
            }

            // åˆ›å»ºæ¸å˜è‰²
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            if (dimension === 'product') {
                gradient.addColorStop(0, 'rgba(0, 123, 255, 0.8)');
                gradient.addColorStop(1, 'rgba(0, 123, 255, 0.2)');
            } else {
                gradient.addColorStop(0, 'rgba(0, 123, 255, 0.3)');
                gradient.addColorStop(1, 'rgba(0, 123, 255, 0.05)');
            }

            const chartConfig = {
                type: dimension === 'product' ? 'bar' : 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é”€å”®é‡‘é¢',
                        data: values,
                        borderColor: '#007bff',
                        backgroundColor: dimension === 'product' ? gradient : gradient,
                        borderWidth: dimension === 'product' ? 1 : 3,
                        fill: true,
                        tension: dimension === 'product' ? 0 : 0.4,
                        pointBackgroundColor: '#007bff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: dimension === 'product' ? 0 : 5,
                        pointHoverRadius: dimension === 'product' ? 0 : 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#007bff',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const orderCount = orderCounts[context.dataIndex];
                                    let label = `é”€å”®é¢: Â¥${value.toLocaleString()}`;
                                    if (orderCount > 0) {
                                        label += `\nè®¢å•æ•°: ${orderCount}`;
                                        const avgOrder = value / orderCount;
                                        label += `\nå¹³å‡è®¢å•: Â¥${avgOrder.toLocaleString()}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return 'Â¥' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return 'Â¥' + (value / 1000).toFixed(1) + 'K';
                                    }
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: dimension !== 'product',
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                },
                                maxRotation: dimension === 'product' ? 45 : 0,
                                maxTicksLimit: dimension === 'product' ? 15 : 12
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            };

            salesTrendChart = new Chart(ctx, chartConfig);
        }

        // åˆ›å»ºå®¢æˆ·ä»·å€¼å›¾è¡¨ - æ”¹è¿›ç‰ˆ
        function createCustomerValueChart(data) {
            const ctx = document.getElementById('customerValueChart').getContext('2d');
            
            if (customerValueChart) {
                customerValueChart.destroy();
            }

            // æ•°æ®éªŒè¯
            if (!data || !Array.isArray(data) || data.length === 0) {
                const chartContainer = ctx.canvas.parentElement;
                chartContainer.innerHTML = '<div class="chart-placeholder">ğŸ‘¥ æš‚æ— å®¢æˆ·ä»·å€¼æ•°æ®</div>';
                return;
            }

            // ç»Ÿè®¡å®¢æˆ·åˆ†ç±»å’Œä»·å€¼
            const segmentStats = {};
            let totalValue = 0;
            
            data.forEach(customer => {
                const segment = customer.customer_segment || 'æœªåˆ†ç±»';
                const value = customer.monetary || customer.customer_value || 0;
                
                if (!segmentStats[segment]) {
                    segmentStats[segment] = { count: 0, totalValue: 0 };
                }
                segmentStats[segment].count++;
                segmentStats[segment].totalValue += value;
                totalValue += value;
            });

            // æŒ‰å®¢æˆ·æ•°é‡æ’åº
            const sortedSegments = Object.entries(segmentStats)
                .sort(([,a], [,b]) => b.count - a.count);

            const labels = sortedSegments.map(([segment]) => segment);
            const values = sortedSegments.map(([,stats]) => stats.count);
            const valueAmounts = sortedSegments.map(([,stats]) => stats.totalValue);
            
            const colors = {
                'å† å†›å®¢æˆ·': '#28a745',
                'å¿ è¯šå®¢æˆ·': '#007bff',
                'æ½œåŠ›å®¢æˆ·': '#ffc107',
                'æ–°å®¢æˆ·': '#17a2b8',
                'é£é™©å®¢æˆ·': '#fd7e14',
                'æµå¤±å®¢æˆ·': '#dc3545',
                'æœªåˆ†ç±»': '#6c757d'
            };

            // åˆ›å»ºæ¸å˜è‰²
            const backgroundColors = labels.map(label => {
                const baseColor = colors[label] || '#6c757d';
                const gradient = ctx.createRadialGradient(150, 150, 0, 150, 150, 150);
                gradient.addColorStop(0, baseColor);
                gradient.addColorStop(1, baseColor + '80');
                return baseColor;
            });

            customerValueChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColors,
                        borderWidth: 3,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, index) => {
                                        const count = data.datasets[0].data[index];
                                        const value = valueAmounts[index];
                                        const percentage = ((count / data.datasets[0].data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                                        
                                        return {
                                            text: `${label} (${count}äºº, ${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[index],
                                            strokeStyle: data.datasets[0].borderColor,
                                            lineWidth: data.datasets[0].borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#007bff',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const count = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((count / total) * 100).toFixed(1);
                                    const value = valueAmounts[context.dataIndex];
                                    
                                    return [
                                        `å®¢æˆ·æ•°é‡: ${count}äºº`,
                                        `å æ¯”: ${percentage}%`,
                                        `æ€»ä»·å€¼: Â¥${value.toLocaleString()}`,
                                        `å¹³å‡ä»·å€¼: Â¥${(value / count).toLocaleString()}`
                                    ];
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        intersect: false
                    }
                }
            });
        }

        // æ˜¾ç¤ºåˆ†ææ ‡ç­¾é¡µ
        function showAnalysisTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            const targetTab = document.getElementById(tabName + '-analysis') || 
                             document.getElementById(tabName + '-detailed-analysis');
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');

            // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½ç›¸åº”æ•°æ®
            switch(tabName) {
                case 'inventory':
                    loadInventoryAnalysis();
                    break;
                case 'customer':
                    loadCustomerAnalysis();
                    break;
                case 'purchase':
                    loadPurchaseAnalysis();
                    break;
            }
        }

        // åŠ è½½åº“å­˜åˆ†æ
        function loadInventoryAnalysis() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            vscode.postMessage({
                command: 'getInventoryAnalysis',
                params: {
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // æ˜¾ç¤ºåº“å­˜åˆ†æç»“æœ
        function displayInventoryAnalysis(data) {
            const summaryDiv = document.getElementById('inventory-summary');
            const deadStockDiv = document.getElementById('dead-stock-table');

            // æ˜¾ç¤ºåº“å­˜æ¦‚è¦
            summaryDiv.innerHTML = `
                <div class="dashboard-grid" style="margin-bottom: 20px;">
                    <div class="metric-card">
                        <h3>ğŸ“Š æ€»ä½“å‘¨è½¬ç‡</h3>
                        <div class="metric-value">${data.overall_turnover_rate || 0}</div>
                        <div class="metric-label">æ¬¡/å¹´</div>
                    </div>
                    <div class="metric-card">
                        <h3>âš¡ å¿«é€Ÿå‘¨è½¬</h3>
                        <div class="metric-value">${data.fast_moving_items || 0}</div>
                        <div class="metric-label">ç§äº§å“</div>
                    </div>
                    <div class="metric-card">
                        <h3>âš ï¸ å‘†æ»åº“å­˜</h3>
                        <div class="metric-value">${data.dead_stock_count || 0}</div>
                        <div class="metric-label">ç§äº§å“</div>
                    </div>
                </div>
            `;

            // æ˜¾ç¤ºå‘†æ»åº“å­˜è¡¨æ ¼
            if (data.dead_stock_items && data.dead_stock_items.length > 0) {
                let tableHtml = `
                    <h4>ğŸš¨ å‘†æ»åº“å­˜è¯¦æƒ…</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>äº§å“åç§°</th>
                                <th>åº“å­˜æ•°é‡</th>
                                <th>åº“å­˜ä»·å€¼</th>
                                <th>å•ä»·</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.dead_stock_items.forEach(item => {
                    tableHtml += `
                        <tr>
                            <td>${item.product_name || 'æœªçŸ¥'}</td>
                            <td>${item.current_stock || 0}</td>
                            <td>${formatCurrency(item.inventory_value || 0)}</td>
                            <td>${formatCurrency(item.unit_price || 0)}</td>
                            <td><span class="status-low">${item.stock_status || 'å‘†æ»'}</span></td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table>';
                deadStockDiv.innerHTML = tableHtml;
            } else {
                deadStockDiv.innerHTML = '<div class="info-message">âœ… æš‚æ— å‘†æ»åº“å­˜</div>';
            }

            // åˆ›å»ºåº“å­˜å‘¨è½¬å›¾è¡¨
            createInventoryChart(data.turnover_analysis || []);
        }

        // åˆ›å»ºåº“å­˜å›¾è¡¨ - æ”¹è¿›ç‰ˆ
        function createInventoryChart(data) {
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            
            if (inventoryChart) {
                inventoryChart.destroy();
            }

            // æ•°æ®éªŒè¯
            if (!data || !Array.isArray(data) || data.length === 0) {
                const chartContainer = ctx.canvas.parentElement;
                chartContainer.innerHTML = '<div class="chart-placeholder">ğŸ“¦ æš‚æ— åº“å­˜å‘¨è½¬æ•°æ®</div>';
                return;
            }

            // æŒ‰å‘¨è½¬ç‡æ’åºå¹¶åˆ†ç±»
            const sortedData = data
                .filter(item => item.turnover_rate !== undefined && item.turnover_rate !== null)
                .sort((a, b) => (b.turnover_rate || 0) - (a.turnover_rate || 0))
                .slice(0, 20);

            const labels = sortedData.map(item => {
                const name = item.product_name || item._id || 'æœªçŸ¥äº§å“';
                return name.length > 15 ? name.substring(0, 15) + '...' : name;
            });
            
            const turnoverRates = sortedData.map(item => item.turnover_rate || 0);
            const stockValues = sortedData.map(item => item.stock_value || item.inventory_value || 0);
            const stockQuantities = sortedData.map(item => item.current_stock || item.stock_quantity || 0);

            // æ™ºèƒ½é¢œè‰²ç¼–ç 
            const backgroundColors = turnoverRates.map(rate => {
                if (rate >= 6) return '#28a745';      // æå¿«å‘¨è½¬ - ç»¿è‰²
                if (rate >= 4) return '#20c997';      // å¿«é€Ÿå‘¨è½¬ - é’ç»¿è‰²
                if (rate >= 2) return '#007bff';      // æ­£å¸¸å‘¨è½¬ - è“è‰²
                if (rate >= 1) return '#ffc107';      // æ…¢é€Ÿå‘¨è½¬ - é»„è‰²
                if (rate >= 0.5) return '#fd7e14';    // å¾ˆæ…¢å‘¨è½¬ - æ©™è‰²
                return '#dc3545';                     // å‘†æ»åº“å­˜ - çº¢è‰²
            });

            // åˆ›å»ºæ¸å˜æ•ˆæœ
            const gradientColors = backgroundColors.map(color => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, color);
                gradient.addColorStop(1, color + '60');
                return gradient;
            });

            inventoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å‘¨è½¬ç‡',
                        data: turnoverRates,
                        backgroundColor: gradientColors,
                        borderColor: backgroundColors,
                        borderWidth: 2,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#007bff',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    const fullName = sortedData[context[0].dataIndex].product_name || 
                                                   sortedData[context[0].dataIndex]._id || 'æœªçŸ¥äº§å“';
                                    return fullName;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const rate = turnoverRates[index];
                                    const value = stockValues[index];
                                    const quantity = stockQuantities[index];
                                    
                                    let status = '';
                                    if (rate >= 6) status = 'æå¿«å‘¨è½¬';
                                    else if (rate >= 4) status = 'å¿«é€Ÿå‘¨è½¬';
                                    else if (rate >= 2) status = 'æ­£å¸¸å‘¨è½¬';
                                    else if (rate >= 1) status = 'æ…¢é€Ÿå‘¨è½¬';
                                    else if (rate >= 0.5) status = 'å¾ˆæ…¢å‘¨è½¬';
                                    else status = 'å‘†æ»åº“å­˜';
                                    
                                    return [
                                        `å‘¨è½¬ç‡: ${rate.toFixed(2)}æ¬¡/å¹´`,
                                        `çŠ¶æ€: ${status}`,
                                        `åº“å­˜ä»·å€¼: Â¥${value.toLocaleString()}`,
                                        `åº“å­˜æ•°é‡: ${quantity.toLocaleString()}`
                                    ];
                                },
                                labelColor: function(context) {
                                    return {
                                        borderColor: backgroundColors[context.dataIndex],
                                        backgroundColor: backgroundColors[context.dataIndex]
                                    };
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return value.toFixed(1) + 'æ¬¡';
                                }
                            },
                            title: {
                                display: true,
                                text: 'å¹´å‘¨è½¬ç‡',
                                color: '#495057',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 10
                                },
                                maxRotation: 45,
                                maxTicksLimit: 20
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeInOutQuart'
                    }
                }
            });

            // æ·»åŠ å›¾ä¾‹è¯´æ˜
            const chartContainer = ctx.canvas.parentElement;
            let legendHtml = `
                <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; font-size: 12px;">
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 12px; height: 12px; background: #28a745; border-radius: 2px;"></div>
                        æå¿«å‘¨è½¬ (â‰¥6æ¬¡)
                    </span>
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 12px; height: 12px; background: #20c997; border-radius: 2px;"></div>
                        å¿«é€Ÿå‘¨è½¬ (4-6æ¬¡)
                    </span>
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 12px; height: 12px; background: #007bff; border-radius: 2px;"></div>
                        æ­£å¸¸å‘¨è½¬ (2-4æ¬¡)
                    </span>
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 12px; height: 12px; background: #ffc107; border-radius: 2px;"></div>
                        æ…¢é€Ÿå‘¨è½¬ (1-2æ¬¡)
                    </span>
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 12px; height: 12px; background: #fd7e14; border-radius: 2px;"></div>
                        å¾ˆæ…¢å‘¨è½¬ (0.5-1æ¬¡)
                    </span>
                    <span style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 2px;"></div>
                        å‘†æ»åº“å­˜ (<0.5æ¬¡)
                    </span>
                </div>
            `;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å›¾ä¾‹ï¼Œé¿å…é‡å¤æ·»åŠ 
            const existingLegend = chartContainer.querySelector('.inventory-legend');
            if (existingLegend) {
                existingLegend.remove();
            }
            
            const legendDiv = document.createElement('div');
            legendDiv.className = 'inventory-legend';
            legendDiv.innerHTML = legendHtml;
            chartContainer.appendChild(legendDiv);
        }

        // åŠ è½½å®¢æˆ·åˆ†æ
        function loadCustomerAnalysis() {
            vscode.postMessage({
                command: 'getCustomerAnalysis',
                params: {}
            });
        }

        // æ˜¾ç¤ºå®¢æˆ·åˆ†æç»“æœ
        function displayCustomerAnalysis(data) {
            const summaryDiv = document.getElementById('customer-summary');
            const tableDiv = document.getElementById('customer-table');

            // ç»Ÿè®¡å®¢æˆ·åˆ†ç±»
            const segmentStats = {};
            data.forEach(customer => {
                const segment = customer.customer_segment || 'æœªåˆ†ç±»';
                if (!segmentStats[segment]) {
                    segmentStats[segment] = { count: 0, totalValue: 0 };
                }
                segmentStats[segment].count++;
                segmentStats[segment].totalValue += customer.monetary || 0;
            });

            // æ˜¾ç¤ºå®¢æˆ·åˆ†ç±»æ±‡æ€»
            let summaryHtml = '<div class="dashboard-grid">';
            Object.entries(segmentStats).forEach(([segment, stats]) => {
                summaryHtml += `
                    <div class="metric-card">
                        <h3>${segment}</h3>
                        <div class="metric-value">${stats.count}</div>
                        <div class="metric-label">${formatCurrency(stats.totalValue)}</div>
                    </div>
                `;
            });
            summaryHtml += '</div>';
            summaryDiv.innerHTML = summaryHtml;

            // æ˜¾ç¤ºè¯¦ç»†å®¢æˆ·è¡¨æ ¼
            let tableHtml = `
                <h4>ğŸ† å®¢æˆ·ä»·å€¼æ’è¡Œæ¦œï¼ˆTop 20ï¼‰</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å®¢æˆ·åç§°</th>
                            <th>RFMè¯„åˆ†</th>
                            <th>å®¢æˆ·åˆ†ç±»</th>
                            <th>è´­ä¹°é‡‘é¢</th>
                            <th>è´­ä¹°é¢‘æ¬¡</th>
                            <th>æœ€è¿‘è´­ä¹°</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.slice(0, 20).forEach((customer, index) => {
                const segmentClass = getSegmentClass(customer.customer_segment);
                tableHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${customer.customer_name || 'æœªçŸ¥'}</td>
                        <td><strong>${customer.rfm_score || 0}</strong></td>
                        <td><span class="${segmentClass}">${customer.customer_segment || 'æœªåˆ†ç±»'}</span></td>
                        <td>${formatCurrency(customer.monetary || 0)}</td>
                        <td>${customer.frequency || 0}æ¬¡</td>
                        <td>${customer.recency || 0}å¤©å‰</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            tableDiv.innerHTML = tableHtml;
        }

        // è·å–å®¢æˆ·åˆ†ç±»æ ·å¼ç±»
        function getSegmentClass(segment) {
            const classMap = {
                'å† å†›å®¢æˆ·': 'status-high',
                'å¿ è¯šå®¢æˆ·': 'status-high',
                'æ½œåŠ›å®¢æˆ·': 'status-medium',
                'æ–°å®¢æˆ·': 'status-medium',
                'é£é™©å®¢æˆ·': 'status-low',
                'æµå¤±å®¢æˆ·': 'status-low'
            };
            return classMap[segment] || '';
        }

        // æ˜¾ç¤ºåˆ†ææ ‡ç­¾é¡µ
        function showAnalysisTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            const targetTab = document.getElementById(tabName + '-analysis') || 
                             document.getElementById(tabName + '-detailed-analysis');
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½ç›¸åº”æ•°æ®
            switch(tabName) {
                case 'inventory':
                    loadInventoryAnalysis();
                    break;
                case 'customer':
                    loadCustomerAnalysis();
                    break;
                case 'purchase':
                    loadPurchaseAnalysis();
                    break;
            }
        }

        // åŠ è½½é‡‡è´­åˆ†æ
        function loadPurchaseAnalysis() {
            showPurchaseTrend('supplier');
        }

        // æ˜¾ç¤ºé‡‡è´­è¶‹åŠ¿
        function showPurchaseTrend(dimension) {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            vscode.postMessage({
                command: 'getPurchaseTrend',
                params: {
                    dimension: dimension,
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // åˆ›å»ºé‡‡è´­è¶‹åŠ¿å›¾è¡¨ - æ”¹è¿›ç‰ˆ
        function createPurchaseTrendChart(data, dimension) {
            const ctx = document.getElementById('purchaseTrendChart').getContext('2d');
            
            if (purchaseTrendChart) {
                purchaseTrendChart.destroy();
            }

            // æ•°æ®éªŒè¯
            if (!data || !Array.isArray(data) || data.length === 0) {
                const chartContainer = ctx.canvas.parentElement;
                chartContainer.innerHTML = '<div class="chart-placeholder">ğŸ›’ æš‚æ— é‡‡è´­è¶‹åŠ¿æ•°æ®</div>';
                return;
            }

            let labels, values, purchaseCounts = [];
            
            if (dimension === 'supplier') {
                // æŒ‰é‡‡è´­é¢æ’åºï¼Œå–å‰12ä¸ªä¾›åº”å•†
                const sortedData = data
                    .sort((a, b) => (b.total_purchases || 0) - (a.total_purchases || 0))
                    .slice(0, 12);
                
                labels = sortedData.map(item => {
                    const name = item.supplier_name || item._id || 'æœªçŸ¥ä¾›åº”å•†';
                    return name.length > 10 ? name.substring(0, 10) + '...' : name;
                });
                values = sortedData.map(item => item.total_purchases || 0);
                purchaseCounts = sortedData.map(item => item.purchase_count || 0);
            } else if (dimension === 'material') {
                // æŒ‰é‡‡è´­é¢æ’åºï¼Œå–å‰12ä¸ªç‰©æ–™
                const sortedData = data
                    .sort((a, b) => (b.total_purchases || 0) - (a.total_purchases || 0))
                    .slice(0, 12);
                
                labels = sortedData.map(item => {
                    const name = item.material_name || item._id || 'æœªçŸ¥ç‰©æ–™';
                    return name.length > 12 ? name.substring(0, 12) + '...' : name;
                });
                values = sortedData.map(item => item.total_purchases || 0);
                purchaseCounts = sortedData.map(item => item.purchase_count || 0);
            } else if (dimension === 'month') {
                // æŒ‰æ—¶é—´æ’åº
                const sortedData = data.sort((a, b) => {
                    const dateA = new Date(a.month || a._id);
                    const dateB = new Date(b.month || b._id);
                    return dateA - dateB;
                });
                
                labels = sortedData.map(item => {
                    const dateStr = item.month || item._id;
                    return new Date(dateStr + '-01').toLocaleDateString('zh-CN', { year: 'numeric', month: 'short' });
                });
                values = sortedData.map(item => item.total_purchases || 0);
                purchaseCounts = sortedData.map(item => item.purchase_count || 0);
            }

            // åˆ›å»ºæ¸å˜è‰²
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            if (dimension === 'month') {
                gradient.addColorStop(0, 'rgba(40, 167, 69, 0.3)');
                gradient.addColorStop(1, 'rgba(40, 167, 69, 0.05)');
            } else {
                gradient.addColorStop(0, 'rgba(40, 167, 69, 0.8)');
                gradient.addColorStop(1, 'rgba(40, 167, 69, 0.2)');
            }

            purchaseTrendChart = new Chart(ctx, {
                type: dimension === 'month' ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é‡‡è´­é‡‘é¢',
                        data: values,
                        borderColor: '#28a745',
                        backgroundColor: gradient,
                        borderWidth: dimension === 'month' ? 3 : 1,
                        fill: true,
                        tension: dimension === 'month' ? 0.4 : 0,
                        pointBackgroundColor: '#28a745',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: dimension === 'month' ? 5 : 0,
                        pointHoverRadius: dimension === 'month' ? 8 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#28a745',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const purchaseCount = purchaseCounts[context.dataIndex];
                                    let label = `é‡‡è´­é‡‘é¢: Â¥${value.toLocaleString()}`;
                                    if (purchaseCount > 0) {
                                        label += `\né‡‡è´­æ¬¡æ•°: ${purchaseCount}`;
                                        const avgPurchase = value / purchaseCount;
                                        label += `\nå¹³å‡é‡‡è´­: Â¥${avgPurchase.toLocaleString()}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return 'Â¥' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return 'Â¥' + (value / 1000).toFixed(1) + 'K';
                                    }
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: dimension === 'month',
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                },
                                maxRotation: dimension === 'month' ? 0 : 45,
                                maxTicksLimit: 12
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // ç”Ÿæˆå¯¹æ¯”åˆ†æ
        function generateComparison() {
            const metricsSelect = document.getElementById('comparison-metrics');
            const dimensionsSelect = document.getElementById('comparison-dimensions');
            
            const selectedMetrics = Array.from(metricsSelect.selectedOptions).map(option => option.value);
            const selectedDimensions = Array.from(dimensionsSelect.selectedOptions).map(option => option.value);

            if (selectedMetrics.length === 0 || selectedDimensions.length === 0) {
                showError('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæŒ‡æ ‡å’Œä¸€ä¸ªç»´åº¦');
                return;
            }

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            showLoading('æ­£åœ¨ç”Ÿæˆå¯¹æ¯”åˆ†æ...');

            vscode.postMessage({
                command: 'getComparisonAnalysis',
                params: {
                    metrics: selectedMetrics,
                    dimensions: selectedDimensions,
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // æ˜¾ç¤ºå¯¹æ¯”åˆ†æç»“æœ
        function displayComparisonAnalysis(data) {
            const resultsDiv = document.getElementById('comparison-results');
            
            let html = '<h4>ğŸ“Š å¯¹æ¯”åˆ†æç»“æœ</h4>';
            
            if (data.sales_analysis && data.sales_analysis.length > 0) {
                html += generateComparisonTable('é”€å”®æ•°æ®åˆ†æ', data.sales_analysis);
            }
            
            if (data.purchase_analysis && data.purchase_analysis.length > 0) {
                html += generateComparisonTable('é‡‡è´­æ•°æ®åˆ†æ', data.purchase_analysis);
            }
            
            if (data.inventory_analysis && data.inventory_analysis.length > 0) {
                html += generateComparisonTable('åº“å­˜æ•°æ®åˆ†æ', data.inventory_analysis);
            }

            resultsDiv.innerHTML = html;
        }

        // ç”Ÿæˆå¯¹æ¯”è¡¨æ ¼
        function generateComparisonTable(title, data) {
            if (!data || data.length === 0) return '';
            
            const firstRow = data[0];
            const headers = Object.keys(firstRow._id);
            const metrics = Object.keys(firstRow).filter(key => key !== '_id');

            let html = `<h5>${title}</h5><table class="data-table"><thead><tr>`;
            
            headers.forEach(header => {
                html += `<th>${getHeaderName(header)}</th>`;
            });
            
            metrics.forEach(metric => {
                html += `<th>${getMetricName(metric)}</th>`;
            });
            
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row._id[header] || 'æœªçŸ¥'}</td>`;
                });
                metrics.forEach(metric => {
                    const value = row[metric] || 0;
                    html += `<td>${metric.includes('amount') || metric.includes('value') ? formatCurrency(value) : value.toLocaleString()}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // è·å–è¡¨å¤´åç§°
        function getHeaderName(header) {
            const names = {
                'month': 'æœˆä»½',
                'product': 'äº§å“',
                'customer': 'å®¢æˆ·',
                'supplier': 'ä¾›åº”å•†',
                'material': 'ç‰©æ–™'
            };
            return names[header] || header;
        }

        // è·å–æŒ‡æ ‡åç§°
        function getMetricName(metric) {
            const names = {
                'total_sales': 'é”€å”®æ€»é¢',
                'sales_count': 'é”€å”®ç¬”æ•°',
                'total_purchases': 'é‡‡è´­æ€»é¢',
                'purchase_count': 'é‡‡è´­ç¬”æ•°',
                'inventory_value': 'åº“å­˜ä»·å€¼',
                'stock_quantity': 'åº“å­˜æ•°é‡'
            };
            return names[metric] || metric;
        }

        // å¯¼å‡ºä»ªè¡¨æ¿
        function exportDashboard() {
            vscode.postMessage({
                command: 'exportDashboard',
                params: {
                    start_date: document.getElementById('start-date').value,
                    end_date: document.getElementById('end-date').value
                }
            });
        }

        // æ ¼å¼åŒ–è´§å¸
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return 'Â¥0.00';
            return 'Â¥' + parseFloat(amount).toLocaleString('zh-CN', { minimumFractionDigits: 2 });
        }

        // å¤„ç†ä»ªè¡¨æ¿æ¦‚è§ˆæ•°æ®
        function handleDashboardData(data) {
            try {
                if (!data || typeof data !== 'object') {
                    throw new Error('æ— æ•ˆçš„ä»ªè¡¨æ¿æ•°æ®æ ¼å¼');
                }

                dashboardData = data;
                
                // ç”Ÿæˆå…³é”®æŒ‡æ ‡å¡ç‰‡
                if (data.overview) {
                    generateMetricCards(data);
                }

                // å¦‚æœåŒ…å«é”€å”®è¶‹åŠ¿æ•°æ®ï¼Œåˆ›å»ºé»˜è®¤å›¾è¡¨
                if (data.sales_trend && Array.isArray(data.sales_trend)) {
                    createSalesTrendChart(data.sales_trend, 'month');
                }

                // å¦‚æœåŒ…å«å®¢æˆ·æ•°æ®ï¼Œåˆ›å»ºå®¢æˆ·ä»·å€¼å›¾è¡¨
                if (data.top_customers && Array.isArray(data.top_customers)) {
                    createCustomerValueChart(data.top_customers);
                }

                console.log('ä»ªè¡¨æ¿æ•°æ®å¤„ç†å®Œæˆ');
            } catch (error) {
                console.error('å¤„ç†ä»ªè¡¨æ¿æ•°æ®æ—¶å‡ºé”™:', error);
                showUserFriendlyError('ä»ªè¡¨æ¿æ•°æ®å¤„ç†å¤±è´¥', error.message);
            }
        }

        // å¤„ç†é”€å”®è¶‹åŠ¿æ•°æ® - æ”¹è¿›ç‰ˆ
        function handleSalesTrendData(data, dimension = 'month') {
            try {
                if (!data || !Array.isArray(data)) {
                    throw new Error('é”€å”®è¶‹åŠ¿æ•°æ®æ ¼å¼æ— æ•ˆ');
                }

                if (data.length === 0) {
                    // æ˜¾ç¤ºæ— æ•°æ®æç¤º
                    const ctx = document.getElementById('salesTrendChart').getContext('2d');
                    if (salesTrendChart) {
                        salesTrendChart.destroy();
                    }
                    
                    const chartContainer = document.querySelector('#salesTrendChart').parentElement;
                    chartContainer.innerHTML = '<div class="chart-placeholder">ğŸ“Š æš‚æ— é”€å”®è¶‹åŠ¿æ•°æ®</div>';
                    return;
                }

                // æ•°æ®æ¸…æ´—å’ŒéªŒè¯
                const cleanedData = data.filter(item => {
                    // è¿‡æ»¤æ‰æ— æ•ˆæ•°æ®
                    if (dimension === 'product') {
                        return item._id && (item.total_sales || 0) > 0;
                    } else {
                        return (item.month || item.quarter || item._id) && (item.total_sales || 0) >= 0;
                    }
                });

                if (cleanedData.length === 0) {
                    const chartContainer = document.querySelector('#salesTrendChart').parentElement;
                    chartContainer.innerHTML = '<div class="chart-placeholder">ğŸ“Š æš‚æ— æœ‰æ•ˆçš„é”€å”®è¶‹åŠ¿æ•°æ®</div>';
                    return;
                }

                // æ•°æ®ç»Ÿè®¡ä¿¡æ¯
                const totalSales = cleanedData.reduce((sum, item) => sum + (item.total_sales || 0), 0);
                const avgSales = totalSales / cleanedData.length;
                
                console.log(`é”€å”®è¶‹åŠ¿æ•°æ®ç»Ÿè®¡ (${dimension}):`, {
                    æ€»è®°å½•æ•°: cleanedData.length,
                    æ€»é”€å”®é¢: totalSales.toLocaleString(),
                    å¹³å‡é”€å”®é¢: avgSales.toLocaleString()
                });

                createSalesTrendChart(cleanedData, dimension);
                console.log(`é”€å”®è¶‹åŠ¿æ•°æ®å¤„ç†å®Œæˆ (${dimension})`);
            } catch (error) {
                console.error('å¤„ç†é”€å”®è¶‹åŠ¿æ•°æ®æ—¶å‡ºé”™:', error);
                showUserFriendlyError('é”€å”®è¶‹åŠ¿æ•°æ®å¤„ç†å¤±è´¥', error.message);
            }
        }

        // å¤„ç†å®¢æˆ·åˆ†ææ•°æ®
        function handleCustomerAnalysisData(data) {
            try {
                if (!data || !Array.isArray(data)) {
                    throw new Error('å®¢æˆ·åˆ†ææ•°æ®æ ¼å¼æ— æ•ˆ');
                }

                if (data.length === 0) {
                    // æ˜¾ç¤ºæ— æ•°æ®æç¤º
                    const summaryDiv = document.getElementById('customer-summary');
                    const tableDiv = document.getElementById('customer-table');
                    
                    if (summaryDiv) {
                        summaryDiv.innerHTML = '<div class="info-message">ğŸ“Š æš‚æ— å®¢æˆ·åˆ†ææ•°æ®</div>';
                    }
                    if (tableDiv) {
                        tableDiv.innerHTML = '<div class="info-message">ğŸ‘¥ æš‚æ— å®¢æˆ·è¯¦ç»†ä¿¡æ¯</div>';
                    }
                    return;
                }

                // éªŒè¯å®¢æˆ·æ•°æ®ç»“æ„
                const requiredFields = ['customer_name', 'customer_segment'];
                const isValidData = data.every(customer => 
                    requiredFields.every(field => customer.hasOwnProperty(field))
                );

                if (!isValidData) {
                    console.warn('éƒ¨åˆ†å®¢æˆ·æ•°æ®ç¼ºå°‘å¿…è¦å­—æ®µï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼');
                }

                // åˆ›å»ºå®¢æˆ·ä»·å€¼å›¾è¡¨
                createCustomerValueChart(data);
                
                // æ˜¾ç¤ºå®¢æˆ·è¯¦ç»†åˆ†æ
                displayCustomerAnalysis(data);
                
                console.log('å®¢æˆ·åˆ†ææ•°æ®å¤„ç†å®Œæˆ');
            } catch (error) {
                console.error('å¤„ç†å®¢æˆ·åˆ†ææ•°æ®æ—¶å‡ºé”™:', error);
                showUserFriendlyError('å®¢æˆ·åˆ†ææ•°æ®å¤„ç†å¤±è´¥', error.message);
            }
        }

        // å¤„ç†åº“å­˜åˆ†ææ•°æ®
        function handleInventoryAnalysisData(data) {
            try {
                if (!data || typeof data !== 'object') {
                    throw new Error('åº“å­˜åˆ†ææ•°æ®æ ¼å¼æ— æ•ˆ');
                }

                // éªŒè¯åº“å­˜æ•°æ®ç»“æ„
                const requiredFields = ['overall_turnover_rate', 'turnover_analysis'];
                const missingFields = requiredFields.filter(field => !data.hasOwnProperty(field));
                
                if (missingFields.length > 0) {
                    console.warn(`åº“å­˜æ•°æ®ç¼ºå°‘å­—æ®µ: ${missingFields.join(', ')}ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼`);
                }

                // ç¡®ä¿æ•°æ®å®Œæ•´æ€§
                const processedData = {
                    overall_turnover_rate: data.overall_turnover_rate || 0,
                    fast_moving_items: data.fast_moving_items || 0,
                    slow_moving_items: data.slow_moving_items || 0,
                    dead_stock_count: data.dead_stock_count || 0,
                    turnover_analysis: data.turnover_analysis || [],
                    dead_stock_items: data.dead_stock_items || []
                };

                displayInventoryAnalysis(processedData);
                console.log('åº“å­˜åˆ†ææ•°æ®å¤„ç†å®Œæˆ');
            } catch (error) {
                console.error('å¤„ç†åº“å­˜åˆ†ææ•°æ®æ—¶å‡ºé”™:', error);
                showUserFriendlyError('åº“å­˜åˆ†ææ•°æ®å¤„ç†å¤±è´¥', error.message);
            }
        }

        // ç»Ÿä¸€é”™è¯¯å¤„ç†å‡½æ•° - å¢å¼ºç‰ˆ
        function handleError(error, context = 'æœªçŸ¥æ“ä½œ') {
            console.error(`${context}å‘ç”Ÿé”™è¯¯:`, error);
            
            // éšè—åŠ è½½çŠ¶æ€
            hideLoading();
            
            // é”™è¯¯åˆ†ç±»å’Œå¤„ç†
            let errorInfo = categorizeError(error, context);
            
            // è®°å½•é”™è¯¯æ—¥å¿—
            logError(error, context, errorInfo);
            
            // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
            showUserFriendlyError(errorInfo.title, errorInfo.message, errorInfo.suggestions, errorInfo.canRetry);
        }

        // é”™è¯¯åˆ†ç±»å‡½æ•°
        function categorizeError(error, context) {
            let errorInfo = {
                title: 'ç³»ç»Ÿé”™è¯¯',
                message: 'å‘ç”ŸæœªçŸ¥é”™è¯¯',
                suggestions: ['è¯·ç¨åé‡è¯•', 'å¦‚é—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'],
                canRetry: true,
                severity: 'medium'
            };

            // æ ¹æ®é”™è¯¯ä»£ç åˆ†ç±»
            if (error && error.code) {
                switch (error.code) {
                    case 'DB_CONNECTION_FAILED':
                    case 'DATABASE_ERROR':
                        errorInfo = {
                            title: 'æ•°æ®åº“è¿æ¥å¤±è´¥',
                            message: 'æ— æ³•è¿æ¥åˆ°æ•°æ®åº“æœåŠ¡å™¨',
                            suggestions: [
                                'æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ',
                                'éªŒè¯æ•°æ®åº“è¿æ¥é…ç½®',
                                'ç¨åé‡è¯•æ“ä½œ'
                            ],
                            canRetry: true,
                            severity: 'high'
                        };
                        break;
                    
                    case 'NETWORK_ERROR':
                    case 'CONNECTION_TIMEOUT':
                        errorInfo = {
                            title: 'ç½‘ç»œè¿æ¥å¤±è´¥',
                            message: 'ç½‘ç»œè¿æ¥è¶…æ—¶æˆ–ä¸­æ–­',
                            suggestions: [
                                'æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€',
                                'ç¡®è®¤æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®',
                                'ç¨åé‡è¯•æ“ä½œ'
                            ],
                            canRetry: true,
                            severity: 'high'
                        };
                        break;
                    
                    case 'DATA_PROCESSING_ERROR':
                    case 'INVALID_DATA_FORMAT':
                        errorInfo = {
                            title: 'æ•°æ®å¤„ç†å¤±è´¥',
                            message: 'æ•°æ®æ ¼å¼æ— æ•ˆæˆ–å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯',
                            suggestions: [
                                'æ£€æŸ¥æ•°æ®å®Œæ•´æ€§',
                                'éªŒè¯æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®',
                                'è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æ•°æ®æº'
                            ],
                            canRetry: false,
                            severity: 'medium'
                        };
                        break;
                    
                    case 'PERMISSION_DENIED':
                    case 'ACCESS_DENIED':
                        errorInfo = {
                            title: 'æƒé™ä¸è¶³',
                            message: 'æ‚¨æ²¡æœ‰æ‰§è¡Œæ­¤æ“ä½œçš„æƒé™',
                            suggestions: [
                                'è”ç³»ç®¡ç†å‘˜è·å–ç›¸åº”æƒé™',
                                'ç¡®è®¤æ‚¨çš„è´¦æˆ·çŠ¶æ€'
                            ],
                            canRetry: false,
                            severity: 'medium'
                        };
                        break;
                    
                    case 'PYTHON_SCRIPT_ERROR':
                        errorInfo = {
                            title: 'æ•°æ®åˆ†ææœåŠ¡é”™è¯¯',
                            message: 'åç«¯æ•°æ®åˆ†æè„šæœ¬æ‰§è¡Œå¤±è´¥',
                            suggestions: [
                                'æ£€æŸ¥Pythonç¯å¢ƒå’Œä¾èµ–åŒ…',
                                'éªŒè¯æ•°æ®åˆ†æè„šæœ¬é…ç½®',
                                'æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—'
                            ],
                            canRetry: true,
                            severity: 'high'
                        };
                        break;
                    
                    case 'TIMEOUT_ERROR':
                        errorInfo = {
                            title: 'æ“ä½œè¶…æ—¶',
                            message: 'æ“ä½œæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå·²è¶…æ—¶',
                            suggestions: [
                                'å‡å°‘æ•°æ®æŸ¥è¯¢èŒƒå›´',
                                'ç¨åé‡è¯•æ“ä½œ',
                                'è”ç³»ç®¡ç†å‘˜ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½'
                            ],
                            canRetry: true,
                            severity: 'medium'
                        };
                        break;
                    
                    case 'MEMORY_ERROR':
                        errorInfo = {
                            title: 'å†…å­˜ä¸è¶³',
                            message: 'ç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œæ— æ³•å®Œæˆæ“ä½œ',
                            suggestions: [
                                'å‡å°‘æ•°æ®å¤„ç†é‡',
                                'å…³é—­å…¶ä»–åº”ç”¨ç¨‹åº',
                                'ç¨åé‡è¯•æ“ä½œ'
                            ],
                            canRetry: true,
                            severity: 'high'
                        };
                        break;
                    
                    default:
                        errorInfo.message = error.message || error.details || 'å‘ç”ŸæœªçŸ¥ç³»ç»Ÿé”™è¯¯';
                        break;
                }
            } else if (typeof error === 'string') {
                // å¤„ç†å­—ç¬¦ä¸²é”™è¯¯
                if (error.toLowerCase().includes('connection')) {
                    errorInfo.title = 'è¿æ¥é”™è¯¯';
                    errorInfo.message = error;
                    errorInfo.severity = 'high';
                } else if (error.toLowerCase().includes('timeout')) {
                    errorInfo.title = 'è¶…æ—¶é”™è¯¯';
                    errorInfo.message = error;
                    errorInfo.severity = 'medium';
                } else if (error.toLowerCase().includes('permission') || error.toLowerCase().includes('access')) {
                    errorInfo.title = 'æƒé™é”™è¯¯';
                    errorInfo.message = error;
                    errorInfo.canRetry = false;
                    errorInfo.severity = 'medium';
                } else {
                    errorInfo.message = error;
                }
            } else if (error && error.message) {
                // å¤„ç†æ ‡å‡†é”™è¯¯å¯¹è±¡
                errorInfo.message = error.message;
                if (error.stack) {
                    console.error('é”™è¯¯å †æ ˆ:', error.stack);
                }
            }

            return errorInfo;
        }

        // é”™è¯¯æ—¥å¿—è®°å½•å‡½æ•°
        function logError(error, context, errorInfo) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp,
                context,
                error: {
                    message: error.message || error,
                    code: error.code,
                    stack: error.stack
                },
                errorInfo,
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            // è®°å½•åˆ°æ§åˆ¶å°
            console.group(`ğŸš¨ é”™è¯¯æ—¥å¿— - ${timestamp}`);
            console.error('ä¸Šä¸‹æ–‡:', context);
            console.error('é”™è¯¯ä¿¡æ¯:', error);
            console.error('åˆ†ç±»ç»“æœ:', errorInfo);
            console.groupEnd();
            
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘é€é”™è¯¯æ—¥å¿—åˆ°æœåŠ¡å™¨çš„é€»è¾‘
            // sendErrorToServer(logEntry);
        }

        // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯ - å¢å¼ºç‰ˆ
        function showUserFriendlyError(title, message = '', suggestions = [], canRetry = true) {
            // éšè—åŠ è½½çŠ¶æ€
            hideLoading();
            
            // ç§»é™¤ä¹‹å‰çš„é”™è¯¯æ¶ˆæ¯
            const existingErrors = document.querySelectorAll('.error-message');
            existingErrors.forEach(error => error.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            
            // æ„å»ºé”™è¯¯æ¶ˆæ¯HTML
            let errorHtml = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="font-size: 24px; flex-shrink: 0;">âŒ</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">${title}</div>
            `;
            
            if (message) {
                errorHtml += `<div style="margin-bottom: 12px; color: #721c24;">${message}</div>`;
            }
            
            // æ·»åŠ å»ºè®®åˆ—è¡¨
            if (suggestions && suggestions.length > 0) {
                errorHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; margin-bottom: 6px;">ğŸ’¡ è§£å†³å»ºè®®ï¼š</div>
                        <ul style="margin: 0; padding-left: 20px; color: #721c24;">
                `;
                suggestions.forEach(suggestion => {
                    errorHtml += `<li style="margin-bottom: 4px;">${suggestion}</li>`;
                });
                errorHtml += '</ul></div>';
            }
            
            // æ·»åŠ æ“ä½œæŒ‰é’®
            errorHtml += '<div style="display: flex; gap: 10px; margin-top: 12px;">';
            
            if (canRetry) {
                errorHtml += `
                    <button class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;" onclick="handleRetryAction('${title}')">
                        ğŸ”„ é‡è¯•
                    </button>
                `;
            }
            
            // æ·»åŠ å…³é—­æŒ‰é’®
            errorHtml += `
                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">
                    âœ–ï¸ å…³é—­
                </button>
            `;
            
            errorHtml += '</div></div></div>';
            
            errorDiv.innerHTML = errorHtml;
            
            // æ’å…¥åˆ°å®¹å™¨é¡¶éƒ¨
            const container = document.querySelector('.container');
            const insertPoint = container.querySelector('.toolbar') || container.firstElementChild.nextElementSibling;
            container.insertBefore(errorDiv, insertPoint);
            
            // æ·»åŠ æ·¡å…¥åŠ¨ç”»
            errorDiv.style.opacity = '0';
            errorDiv.style.transform = 'translateY(-10px)';
            errorDiv.style.transition = 'all 0.3s ease';
            
            setTimeout(() => {
                errorDiv.style.opacity = '1';
                errorDiv.style.transform = 'translateY(0)';
            }, 10);
            
            // 10ç§’åè‡ªåŠ¨ç§»é™¤ï¼ˆé™¤éç”¨æˆ·äº¤äº’ï¼‰
            setTimeout(() => {
                if (errorDiv.parentNode && !errorDiv.dataset.userInteracted) {
                    errorDiv.style.opacity = '0';
                    errorDiv.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        if (errorDiv.parentNode) {
                            errorDiv.remove();
                        }
                    }, 300);
                }
            }, 10000);
            
            // æ ‡è®°ç”¨æˆ·äº¤äº’
            errorDiv.addEventListener('click', () => {
                errorDiv.dataset.userInteracted = 'true';
            });
        }

        // å¤„ç†é‡è¯•æ“ä½œ
        function handleRetryAction(errorTitle) {
            // æ ¹æ®é”™è¯¯ç±»å‹æ‰§è¡Œç›¸åº”çš„é‡è¯•æ“ä½œ
            if (errorTitle.includes('æ•°æ®åº“è¿æ¥') || errorTitle.includes('ç½‘ç»œè¿æ¥') || 
                errorTitle.includes('æ•°æ®åˆ†ææœåŠ¡') || errorTitle.includes('æ“ä½œè¶…æ—¶')) {
                refreshDashboard();
            } else if (errorTitle.includes('é”€å”®è¶‹åŠ¿')) {
                // é‡æ–°åŠ è½½å½“å‰é€‰ä¸­çš„é”€å”®è¶‹åŠ¿
                const activeTab = document.querySelector('.analysis-tab.active');
                if (activeTab) {
                    const dimension = activeTab.textContent.includes('æœˆåº¦') ? 'month' : 
                                    activeTab.textContent.includes('å­£åº¦') ? 'quarter' : 'product';
                    showSalesTrend(dimension);
                }
            } else if (errorTitle.includes('åº“å­˜åˆ†æ')) {
                loadInventoryAnalysis();
            } else if (errorTitle.includes('å®¢æˆ·åˆ†æ')) {
                loadCustomerAnalysis();
            } else if (errorTitle.includes('é‡‡è´­è¶‹åŠ¿')) {
                loadPurchaseAnalysis();
            } else {
                // é»˜è®¤é‡è¯•æ“ä½œ
                refreshDashboard();
            }
        }

        // ç›‘å¬æ¥è‡ªVSCodeçš„æ¶ˆæ¯ - å®Œå–„çš„æ¶ˆæ¯å¤„ç†å™¨
        window.addEventListener('message', event => {
            const message = event.data;
            
            try {
                // éªŒè¯æ¶ˆæ¯æ ¼å¼
                if (!message || typeof message !== 'object') {
                    throw new Error('æ”¶åˆ°æ— æ•ˆçš„æ¶ˆæ¯æ ¼å¼');
                }

                // è®°å½•æ¶ˆæ¯æ¥æ”¶æ—¥å¿—
                console.log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${message.command}`, message);

                switch (message.command) {
                    case 'dashboardData':
                        hideLoading();
                        if (message.success) {
                            handleDashboardData(message.data);
                        } else {
                            const error = message.error || { message: 'åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥' };
                            handleError(error, 'ä»ªè¡¨æ¿æ•°æ®åŠ è½½');
                        }
                        break;

                    case 'salesTrendData':
                        hideLoading();
                        if (message.success) {
                            handleSalesTrendData(message.data, message.dimension);
                        } else {
                            const error = message.error || { message: 'åŠ è½½é”€å”®è¶‹åŠ¿å¤±è´¥' };
                            handleError(error, 'é”€å”®è¶‹åŠ¿åˆ†æ');
                        }
                        break;

                    case 'inventoryAnalysisData':
                        hideLoading();
                        if (message.success) {
                            handleInventoryAnalysisData(message.data);
                        } else {
                            const error = message.error || { message: 'åŠ è½½åº“å­˜åˆ†æå¤±è´¥' };
                            handleError(error, 'åº“å­˜åˆ†æ');
                        }
                        break;

                    case 'customerAnalysisData':
                        hideLoading();
                        if (message.success) {
                            handleCustomerAnalysisData(message.data);
                        } else {
                            const error = message.error || { message: 'åŠ è½½å®¢æˆ·åˆ†æå¤±è´¥' };
                            handleError(error, 'å®¢æˆ·åˆ†æ');
                        }
                        break;

                    case 'purchaseTrendData':
                        hideLoading();
                        if (message.success) {
                            createPurchaseTrendChart(message.data, message.dimension);
                        } else {
                            const error = message.error || { message: 'åŠ è½½é‡‡è´­è¶‹åŠ¿å¤±è´¥' };
                            handleError(error, 'é‡‡è´­è¶‹åŠ¿åˆ†æ');
                        }
                        break;

                    case 'comparisonAnalysisData':
                        hideLoading();
                        if (message.success) {
                            displayComparisonAnalysis(message.data);
                        } else {
                            const error = message.error || { message: 'ç”Ÿæˆå¯¹æ¯”åˆ†æå¤±è´¥' };
                            handleError(error, 'å¯¹æ¯”åˆ†æ');
                        }
                        break;

                    case 'exportResult':
                        hideLoading();
                        if (message.success) {
                            showSuccessMessage('ä»ªè¡¨æ¿æŠ¥å‘Šå·²å¯¼å‡ºæˆåŠŸ');
                        } else {
                            const error = message.error || { message: 'å¯¼å‡ºå¤±è´¥' };
                            handleError(error, 'æŠ¥å‘Šå¯¼å‡º');
                        }
                        break;

                    case 'connectionStatus':
                        // å¤„ç†è¿æ¥çŠ¶æ€æ›´æ–°
                        handleConnectionStatus(message.status, message.details);
                        break;

                    case 'progress':
                        // å¤„ç†è¿›åº¦æ›´æ–°
                        if (message.progress !== undefined) {
                            updateLoadingStatus(message.message || 'å¤„ç†ä¸­...', message.progress);
                        }
                        break;

                    case 'error':
                        hideLoading();
                        const error = message.error || message.message || { message: 'ç³»ç»Ÿé”™è¯¯' };
                        handleError(error, message.context || 'ç³»ç»Ÿæ“ä½œ');
                        break;

                    case 'warning':
                        showWarningMessage(message.message || 'ç³»ç»Ÿè­¦å‘Š');
                        break;

                    case 'info':
                        showInfoMessage(message.message || 'ç³»ç»Ÿä¿¡æ¯');
                        break;

                    default:
                        console.warn('æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.command, message);
                        // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œåªè®°å½•æ—¥å¿—
                        break;
                }
            } catch (processingError) {
                console.error('å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯:', processingError);
                hideLoading();
                handleError({
                    code: 'MESSAGE_PROCESSING_ERROR',
                    message: 'æ¶ˆæ¯å¤„ç†å¤±è´¥: ' + processingError.message,
                    details: processingError.stack
                }, 'æ¶ˆæ¯å¤„ç†');
            }
        });

        // å¤„ç†è¿æ¥çŠ¶æ€
        function handleConnectionStatus(status, details) {
            const statusMessages = {
                'connecting': 'æ­£åœ¨è¿æ¥æ•°æ®åº“...',
                'connected': 'æ•°æ®åº“è¿æ¥æˆåŠŸ',
                'disconnected': 'æ•°æ®åº“è¿æ¥å·²æ–­å¼€',
                'error': 'æ•°æ®åº“è¿æ¥å¤±è´¥'
            };

            const message = statusMessages[status] || 'æœªçŸ¥è¿æ¥çŠ¶æ€';
            
            if (status === 'connected') {
                showSuccessMessage(message);
            } else if (status === 'error') {
                handleError({
                    code: 'DB_CONNECTION_FAILED',
                    message: message,
                    details: details
                }, 'æ•°æ®åº“è¿æ¥');
            } else if (status === 'disconnected') {
                showWarningMessage(message + ' - æŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨');
            } else {
                updateLoadingStatus(message);
            }
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">âœ…</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; font-size: 16px; cursor: pointer;">âœ–ï¸</button>
                </div>
            `;
            
            const container = document.querySelector('.container');
            const insertPoint = container.querySelector('.toolbar') || container.firstElementChild.nextElementSibling;
            container.insertBefore(successDiv, insertPoint);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 5000);
        }

        // æ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
        function showWarningMessage(message) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'info-message';
            warningDiv.style.borderLeftColor = '#ffc107';
            warningDiv.style.backgroundColor = '#fff3cd';
            warningDiv.style.color = '#856404';
            warningDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">âš ï¸</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; font-size: 16px; cursor: pointer;">âœ–ï¸</button>
                </div>
            `;
            
            const container = document.querySelector('.container');
            const insertPoint = container.querySelector('.toolbar') || container.firstElementChild.nextElementSibling;
            container.insertBefore(warningDiv, insertPoint);
            
            // 8ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.remove();
                }
            }, 8000);
        }

        // æ˜¾ç¤ºä¿¡æ¯æ¶ˆæ¯
        function showInfoMessage(message) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info-message';
            infoDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">â„¹ï¸</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; font-size: 16px; cursor: pointer;">âœ–ï¸</button>
                </div>
            `;
            
            const container = document.querySelector('.container');
            const insertPoint = container.querySelector('.toolbar') || container.firstElementChild.nextElementSibling;
            container.insertBefore(infoDiv, insertPoint);
            
            // 6ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (infoDiv.parentNode) {
                    infoDiv.remove();
                }
            }, 6000);
        }
    </script>
</body>
</html> 