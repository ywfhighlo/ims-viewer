<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据分析仪表板</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        
        .toolbar { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .toolbar-row { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .date-group { display: flex; gap: 15px; align-items: center; }
        .date-group label { font-weight: 500; color: #555; }
        .date-group input { padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #007bff; }
        .metric-card h3 { color: #495057; font-size: 1.1em; margin-bottom: 15px; }
        .metric-value { font-size: 2.5em; font-weight: bold; color: #007bff; margin-bottom: 5px; }
        .metric-label { color: #6c757d; font-size: 0.9em; }
        
        .analysis-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .panel { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .panel-header { background: #f8f9fa; padding: 20px; border-bottom: 1px solid #e9ecef; }
        .panel-header h3 { color: #495057; font-size: 1.2em; }
        .panel-content { padding: 25px; }
        
        .chart-container { height: 300px; position: relative; }
        .chart-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d; font-size: 1.1em; background: #f8f9fa; border-radius: 8px; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .loading-content { background: white; padding: 30px; border-radius: 12px; text-align: center; min-width: 320px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .analysis-panels { grid-template-columns: 1fr; }
            .toolbar-row { flex-direction: column; align-items: stretch; gap: 15px; }
            .chart-container { height: 250px; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 数据分析仪表板</h1>
            <p>实时业务洞察 | 智能分析 | 数据驱动决策</p>
        </div>

        <div class="toolbar">
            <div class="toolbar-row">
                <div class="date-group">
                    <label for="start-date">开始日期：</label>
                    <input type="date" id="start-date" name="start_date">
                    <label for="end-date">结束日期：</label>
                    <input type="date" id="end-date" name="end_date">
                </div>
                <button class="btn btn-primary" onclick="refreshDashboard()">🔄 刷新数据</button>
            </div>
        </div>

        <div id="metrics-grid" class="dashboard-grid">
            <!-- 动态生成的指标卡片 -->
        </div>

        <div class="analysis-panels">
            <div class="panel">
                <div class="panel-header">
                    <h3>📈 销售趋势分析</h3>
                </div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3>👥 客户价值分析</h3>
                </div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="customerValueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">正在加载数据...</h3>
            <p id="loadingMessage">请稍候，正在分析您的业务数据...</p>
        </div>
    </div>

    <script>
        // VS Code API
        const vsCodeApi = (typeof acquireVsCodeApi !== 'undefined') ? acquireVsCodeApi() : {
            postMessage: function(message) {
                console.log('模拟VS Code API调用:', message);
            }
        };
        
        // 全局变量
        let dashboardData = null;
        let salesTrendChart = null;
        let customerValueChart = null;

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            
            document.getElementById('start-date').value = threeMonthsAgo.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];

            // 检查是否在VS Code环境中
            if (typeof acquireVsCodeApi === 'undefined') {
                // 浏览器环境，加载模拟数据
                loadMockData();
            } else {
                // VS Code环境，请求真实数据
                refreshDashboard();
            }
        });

        // 加载模拟数据（用于浏览器预览）
        function loadMockData() {
            showLoading('正在加载模拟数据...', '展示仪表板功能...');
            
            // 模拟延迟
            setTimeout(() => {
                const mockData = {
                    overview: {
                        total_sales: 1250000.50,
                        total_sales_count: 342,
                        active_customers: 89,
                        avg_order_value: 3654.68
                    },
                    sales_trend: [
                        { period: '2024-01', total_sales: 180000 },
                        { period: '2024-02', total_sales: 220000 },
                        { period: '2024-03', total_sales: 195000 },
                        { period: '2024-04', total_sales: 240000 },
                        { period: '2024-05', total_sales: 210000 },
                        { period: '2024-06', total_sales: 205000 }
                    ],
                    top_customers: [
                        { customer_name: '华为技术有限公司', monetary: 85000 },
                        { customer_name: '腾讯科技', monetary: 72000 },
                        { customer_name: '阿里巴巴集团', monetary: 68000 },
                        { customer_name: '百度在线', monetary: 55000 },
                        { customer_name: '京东集团', monetary: 48000 },
                        { customer_name: '小米科技', monetary: 42000 },
                        { customer_name: '字节跳动', monetary: 38000 },
                        { customer_name: '美团点评', monetary: 35000 }
                    ]
                };
                
                handleDashboardData(mockData);
            }, 1500);
        }

        // 监听消息
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.command) {
                case 'dashboardData':
                    handleDashboardData(message.data);
                    break;
                case 'error':
                    handleError(message.error);
                    break;
                default:
                    console.log('未知消息类型:', message.command);
            }
        });

        // 刷新仪表板
        function refreshDashboard() {
            showLoading('正在加载仪表板数据...', '分析您的业务数据，请稍候...');
            
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            vsCodeApi.postMessage({
                command: 'getDashboardData',
                params: {
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // 处理仪表板数据
        function handleDashboardData(response) {
            try {
                console.log('收到仪表板响应:', response);
                
                // 验证响应格式并提取数据
                if (response && response.success && response.data) {
                    dashboardData = response.data;
                    console.log('提取的仪表板数据:', dashboardData);
                    
                    // 使用提取的数据生成指标卡片
                    generateMetricCards(dashboardData);
                    
                    // 生成模拟的销售趋势数据
                    const mockSalesTrend = generateMockSalesTrend(dashboardData);
                    createSalesTrendChart(mockSalesTrend);
                    
                    // 生成模拟的客户价值数据
                    const mockCustomers = generateMockCustomerData(dashboardData);
                    createCustomerValueChart(mockCustomers);
                    
                    hideLoading();
                    console.log('仪表板数据处理完成');
                } else {
                     console.error('无效的数据格式:', response);
                     hideLoading();
                     showError('收到的数据格式无效');
                 }
            } catch (error) {
                console.error('处理仪表板数据时出错:', error);
                hideLoading();
                showError('仪表板数据处理失败: ' + error.message);
            }
        }

        // 生成模拟销售趋势数据
        function generateMockSalesTrend(data) {
            const months = ['1月', '2月', '3月', '4月', '5月', '6月'];
            const baseSales = data.total_sales || 0;
            
            return months.map((month, index) => ({
                period: month,
                total_sales: baseSales * (0.8 + Math.random() * 0.4) / 6
            }));
        }
        
        // 生成模拟客户数据
        function generateMockCustomerData(data) {
            const customerNames = ['客户A', '客户B', '客户C', '客户D', '客户E'];
            const totalValue = data.total_sales || 1000;
            
            return customerNames.map((name, index) => ({
                customer_name: name,
                monetary: totalValue * (0.3 - index * 0.05)
            }));
        }

        // 生成关键指标卡片
        function generateMetricCards(data) {
            const metricsGrid = document.getElementById('metrics-grid');
            const overview = data || {};

            const metrics = [
                {
                    title: '总销售额',
                    value: formatCurrency(overview.total_sales || 0),
                    label: '本期销售总额',
                    icon: '💰'
                },
                {
                    title: '库存总值',
                    value: formatCurrency(overview.total_inventory_value || 0),
                    label: '当前库存价值',
                    icon: '📦'
                },
                {
                    title: '库存商品',
                    value: (overview.total_inventory_items || 0).toLocaleString() + ' 种',
                    label: '库存商品种类',
                    icon: '📋'
                },
                {
                    title: '缺货商品',
                    value: (overview.out_of_stock_items || 0).toLocaleString() + ' 种',
                    label: '需要补货',
                    icon: '⚠️'
                },
                {
                    title: '总采购额',
                    value: formatCurrency(overview.total_purchases || 0),
                    label: '本期采购总额',
                    icon: '🛒'
                },
                {
                    title: '活跃供应商',
                    value: (overview.active_suppliers || 0).toLocaleString(),
                    label: '供应商数量',
                    icon: '🏭'
                }
            ];

            let cardsHtml = '';
            metrics.forEach(metric => {
                cardsHtml += `
                    <div class="metric-card">
                        <h3>${metric.icon} ${metric.title}</h3>
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                    </div>
                `;
            });

            metricsGrid.innerHTML = cardsHtml;
        }

        // 创建销售趋势图表
        function createSalesTrendChart(data) {
            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            
            if (salesTrendChart) {
                salesTrendChart.destroy();
            }

            const labels = data.map(item => item.period || item.month || '未知');
            const values = data.map(item => item.total_sales || item.sales || 0);

            salesTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '销售额',
                        data: values,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // 创建客户价值图表
        function createCustomerValueChart(data) {
            const ctx = document.getElementById('customerValueChart').getContext('2d');
            
            if (customerValueChart) {
                customerValueChart.destroy();
            }

            const labels = data.slice(0, 10).map(item => item.customer_name || '未知客户');
            const values = data.slice(0, 10).map(item => item.monetary || 0);

            customerValueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '客户价值',
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // 格式化货币
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '¥0.00';
            return '¥' + parseFloat(amount).toLocaleString('zh-CN', { minimumFractionDigits: 2 });
        }

        // 显示加载状态
        function showLoading(title = '正在加载...', message = '请稍候...') {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // 显示错误信息
        function showError(message) {
            hideLoading();
            alert('错误: ' + message);
        }

        // 处理错误
        function handleError(error) {
            console.error('发生错误:', error);
            showError(error.message || '未知错误');
        }
    </script>
</body>
</html>