<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†æä»ªè¡¨æ¿</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        
        /* å·¥å…·æ  */
        .toolbar { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .toolbar-row { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .date-group { display: flex; gap: 15px; align-items: center; }
        .date-group label { font-weight: 500; color: #555; }
        .date-group input { padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        
        /* å¡ç‰‡ç½‘æ ¼ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #007bff; }
        .metric-card h3 { color: #495057; font-size: 1.1em; margin-bottom: 15px; }
        .metric-value { font-size: 2.5em; font-weight: bold; color: #007bff; margin-bottom: 5px; }
        .metric-label { color: #6c757d; font-size: 0.9em; }
        .metric-change { font-size: 0.85em; margin-top: 10px; }
        .metric-change.positive { color: #28a745; }
        .metric-change.negative { color: #dc3545; }
        
        /* åˆ†æé¢æ¿ */
        .analysis-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .panel { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .panel-header { background: #f8f9fa; padding: 20px; border-bottom: 1px solid #e9ecef; }
        .panel-header h3 { color: #495057; font-size: 1.2em; }
        .panel-content { padding: 25px; }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-container { height: 300px; position: relative; }
        .chart-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d; font-size: 1.1em; background: #f8f9fa; border-radius: 8px; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
        .data-table th { background: #f8f9fa; font-weight: 600; color: #495057; }
        .data-table tbody tr:hover { background: #f8f9fa; }
        
        /* æ ‡ç­¾é¡µ */
        .analysis-tabs { display: flex; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; padding: 4px; }
        .analysis-tab { flex: 1; padding: 12px 20px; background: transparent; border: none; cursor: pointer; font-size: 14px; font-weight: 500; border-radius: 6px; transition: all 0.3s ease; }
        .analysis-tab.active { background: white; color: #007bff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .loading-content { background: white; padding: 30px; border-radius: 12px; text-align: center; min-width: 320px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .analysis-panels { grid-template-columns: 1fr; }
            .toolbar-row { flex-direction: column; align-items: stretch; }
            .date-group { flex-wrap: wrap; }
        }
        
        /* çŠ¶æ€é¢œè‰² */
        .status-high { color: #28a745; font-weight: bold; }
        .status-medium { color: #ffc107; font-weight: bold; }
        .status-low { color: #dc3545; font-weight: bold; }
        
        /* è¿›åº¦æ¡ */
        .progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: #007bff; transition: width 0.3s ease; }
        
        /* é”™è¯¯å’ŒæˆåŠŸæ¶ˆæ¯ */
        .error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #dc3545; }
        .success-message { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #28a745; }
        .info-message { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #17a2b8; }
        
        /* å·¥å…·æç¤º */
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 12px; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ•°æ®åˆ†æä»ªè¡¨æ¿</h1>
            <p>å®æ—¶ä¸šåŠ¡æ´å¯Ÿ | æ™ºèƒ½åˆ†æ | æ•°æ®é©±åŠ¨å†³ç­–</p>
        </div>

        <!-- å·¥å…·æ  -->
        <div class="toolbar">
            <div class="toolbar-row">
                <div class="date-group">
                    <label for="start-date">å¼€å§‹æ—¥æœŸï¼š</label>
                    <input type="date" id="start-date" name="start_date">
                    <label for="end-date">ç»“æŸæ—¥æœŸï¼š</label>
                    <input type="date" id="end-date" name="end_date">
                </div>
                <button class="btn btn-primary" onclick="refreshDashboard()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button class="btn btn-secondary" onclick="exportDashboard()">ğŸ“ å¯¼å‡ºæŠ¥å‘Š</button>
            </div>
        </div>

        <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
        <div id="metrics-grid" class="dashboard-grid">
            <!-- åŠ¨æ€ç”Ÿæˆçš„æŒ‡æ ‡å¡ç‰‡ -->
        </div>

        <!-- åˆ†æé¢æ¿ -->
        <div class="analysis-panels">
            <!-- é”€å”®è¶‹åŠ¿åˆ†æ -->
            <div class="panel">
                <div class="panel-header">
                    <h3>ğŸ“ˆ é”€å”®è¶‹åŠ¿åˆ†æ</h3>
                </div>
                <div class="panel-content">
                    <div class="analysis-tabs">
                        <button class="analysis-tab active" onclick="showSalesTrend('month')">æœˆåº¦è¶‹åŠ¿</button>
                        <button class="analysis-tab" onclick="showSalesTrend('quarter')">å­£åº¦è¶‹åŠ¿</button>
                        <button class="analysis-tab" onclick="showSalesTrend('product')">äº§å“åˆ†æ</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- å®¢æˆ·ä»·å€¼åˆ†æ -->
            <div class="panel">
                <div class="panel-header">
                    <h3>ğŸ‘¥ å®¢æˆ·ä»·å€¼åˆ†æ (RFM)</h3>
                </div>
                <div class="panel-content">
                    <div id="customer-analysis" class="tab-content active">
                        <div class="chart-container">
                            <canvas id="customerValueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†åˆ†ææ ‡ç­¾é¡µ -->
        <div class="panel">
            <div class="panel-header">
                <h3>ğŸ” è¯¦ç»†åˆ†æ</h3>
            </div>
            <div class="panel-content">
                <div class="analysis-tabs">
                    <button class="analysis-tab active" onclick="showAnalysisTab('inventory')">åº“å­˜åˆ†æ</button>
                    <button class="analysis-tab" onclick="showAnalysisTab('customer')">å®¢æˆ·åˆ†æ</button>
                    <button class="analysis-tab" onclick="showAnalysisTab('purchase')">é‡‡è´­åˆ†æ</button>
                    <button class="analysis-tab" onclick="showAnalysisTab('comparison')">å¯¹æ¯”åˆ†æ</button>
                </div>

                <!-- åº“å­˜åˆ†æ -->
                <div id="inventory-analysis" class="tab-content active">
                    <h4>ğŸ“¦ åº“å­˜å‘¨è½¬åˆ†æ</h4>
                    <div id="inventory-summary"></div>
                    <div class="chart-container">
                        <canvas id="inventoryChart"></canvas>
                    </div>
                    <div id="dead-stock-table"></div>
                </div>

                <!-- å®¢æˆ·åˆ†æ -->
                <div id="customer-detailed-analysis" class="tab-content">
                    <h4>ğŸ‘¤ å®¢æˆ·è¯¦ç»†åˆ†æ</h4>
                    <div id="customer-summary"></div>
                    <div id="customer-table"></div>
                </div>

                <!-- é‡‡è´­åˆ†æ -->
                <div id="purchase-analysis" class="tab-content">
                    <h4>ğŸ›’ é‡‡è´­è¶‹åŠ¿åˆ†æ</h4>
                    <div class="analysis-tabs">
                        <button class="analysis-tab active" onclick="showPurchaseTrend('supplier')">ä¾›åº”å•†åˆ†æ</button>
                        <button class="analysis-tab" onclick="showPurchaseTrend('material')">ç‰©æ–™åˆ†æ</button>
                        <button class="analysis-tab" onclick="showPurchaseTrend('month')">æœˆåº¦è¶‹åŠ¿</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="purchaseTrendChart"></canvas>
                    </div>
                </div>

                <!-- å¯¹æ¯”åˆ†æ -->
                <div id="comparison-analysis" class="tab-content">
                    <h4>âš–ï¸ å¤šç»´åº¦å¯¹æ¯”åˆ†æ</h4>
                    <div class="toolbar-row" style="margin-bottom: 20px;">
                        <select id="comparison-metrics" multiple style="width: 200px; height: 80px;">
                            <option value="total_sales">æ€»é”€å”®é¢</option>
                            <option value="sales_count">é”€å”®ç¬”æ•°</option>
                            <option value="total_purchases">æ€»é‡‡è´­é¢</option>
                            <option value="purchase_count">é‡‡è´­ç¬”æ•°</option>
                        </select>
                        <select id="comparison-dimensions" multiple style="width: 200px; height: 80px;">
                            <option value="month">æœˆä»½</option>
                            <option value="product">äº§å“</option>
                            <option value="customer">å®¢æˆ·</option>
                            <option value="supplier">ä¾›åº”å•†</option>
                        </select>
                        <button class="btn btn-primary" onclick="generateComparison()">ç”Ÿæˆå¯¹æ¯”</button>
                    </div>
                    <div id="comparison-results"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é®ç½©å±‚ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">æ­£åœ¨åŠ è½½æ•°æ®...</h3>
            <p id="loadingMessage">è¯·ç¨å€™ï¼Œæ­£åœ¨åˆ†ææ‚¨çš„ä¸šåŠ¡æ•°æ®...</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const vscode = acquireVsCodeApi();
        let dashboardData = null;
        let salesTrendChart = null;
        let customerValueChart = null;
        let inventoryChart = null;
        let purchaseTrendChart = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæœ€è¿‘3ä¸ªæœˆï¼‰
            const today = new Date();
            const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            
            document.getElementById('start-date').value = threeMonthsAgo.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];

            // åŠ è½½åˆå§‹æ•°æ®
            refreshDashboard();
        });

        // åˆ·æ–°ä»ªè¡¨æ¿
        function refreshDashboard() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                showError('è¯·é€‰æ‹©åˆ†ææ—¥æœŸèŒƒå›´');
                return;
            }

            showLoading('æ­£åœ¨åŠ è½½ä»ªè¡¨æ¿æ•°æ®...');

            vscode.postMessage({
                command: 'getDashboardData',
                params: {
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(title, message = 'è¯·ç¨å€™ï¼Œæ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...') {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            hideLoading();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `âŒ ${message}`;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.dashboard-grid'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // ç”Ÿæˆå…³é”®æŒ‡æ ‡å¡ç‰‡
        function generateMetricCards(data) {
            const metricsGrid = document.getElementById('metrics-grid');
            const overview = data.overview || {};

            const metrics = [
                {
                    title: 'æ€»é”€å”®é¢',
                    value: formatCurrency(overview.total_sales || 0),
                    label: 'æœ¬æœŸé”€å”®æ€»é¢',
                    icon: 'ğŸ’°'
                },
                {
                    title: 'æ€»è®¢å•æ•°',
                    value: (overview.total_sales_count || 0).toLocaleString(),
                    label: 'æœ¬æœŸè®¢å•æ€»æ•°',
                    icon: 'ğŸ“‹'
                },
                {
                    title: 'æ´»è·ƒå®¢æˆ·',
                    value: (overview.active_customers || 0).toLocaleString(),
                    label: `å®¢æˆ·æ´»è·ƒåº¦ ${((overview.customer_activity_rate || 0)).toFixed(1)}%`,
                    icon: 'ğŸ‘¥'
                },
                {
                    title: 'åº“å­˜ä»·å€¼',
                    value: formatCurrency(overview.total_inventory_value || 0),
                    label: `ä½åº“å­˜é¢„è­¦ ${overview.low_stock_items || 0} é¡¹`,
                    icon: 'ğŸ“¦'
                },
                {
                    title: 'å¹³å‡è®¢å•ä»·å€¼',
                    value: formatCurrency(overview.avg_order_value || 0),
                    label: 'æ¯å•å¹³å‡é‡‘é¢',
                    icon: 'ğŸ’³'
                },
                {
                    title: 'æ¯›åˆ©æ¶¦',
                    value: formatCurrency(overview.gross_margin || 0),
                    label: 'é”€å”®é¢ - é‡‡è´­é¢',
                    icon: 'ğŸ“ˆ'
                }
            ];

            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <h3>${metric.icon} ${metric.title}</h3>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºé”€å”®è¶‹åŠ¿
        function showSalesTrend(dimension) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            showLoading('æ­£åœ¨åŠ è½½é”€å”®è¶‹åŠ¿æ•°æ®...');

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            vscode.postMessage({
                command: 'getSalesTrend',
                params: {
                    dimension: dimension,
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // åˆ›å»ºé”€å”®è¶‹åŠ¿å›¾è¡¨
        function createSalesTrendChart(data, dimension) {
            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            
            if (salesTrendChart) {
                salesTrendChart.destroy();
            }

            let labels, values;
            
            if (dimension === 'month' || dimension === 'quarter') {
                labels = data.map(item => item.month || item.quarter || item._id);
                values = data.map(item => item.total_sales || 0);
            } else if (dimension === 'product') {
                labels = data.slice(0, 10).map(item => item._id || 'æœªçŸ¥äº§å“');
                values = data.slice(0, 10).map(item => item.total_sales || 0);
            }

            salesTrendChart = new Chart(ctx, {
                type: dimension === 'product' ? 'bar' : 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é”€å”®é‡‘é¢',
                        data: values,
                        borderColor: '#007bff',
                        backgroundColor: dimension === 'product' ? '#007bff' : 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: dimension !== 'product'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // åˆ›å»ºå®¢æˆ·ä»·å€¼å›¾è¡¨
        function createCustomerValueChart(data) {
            const ctx = document.getElementById('customerValueChart').getContext('2d');
            
            if (customerValueChart) {
                customerValueChart.destroy();
            }

            // ç»Ÿè®¡å®¢æˆ·åˆ†ç±»
            const segmentCounts = {};
            data.forEach(customer => {
                const segment = customer.customer_segment || 'æœªåˆ†ç±»';
                segmentCounts[segment] = (segmentCounts[segment] || 0) + 1;
            });

            const labels = Object.keys(segmentCounts);
            const values = Object.values(segmentCounts);
            
            const colors = {
                'å† å†›å®¢æˆ·': '#28a745',
                'å¿ è¯šå®¢æˆ·': '#007bff',
                'æ½œåŠ›å®¢æˆ·': '#ffc107',
                'æ–°å®¢æˆ·': '#17a2b8',
                'é£é™©å®¢æˆ·': '#fd7e14',
                'æµå¤±å®¢æˆ·': '#dc3545'
            };

            customerValueChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: labels.map(label => colors[label] || '#6c757d'),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // æ˜¾ç¤ºåˆ†ææ ‡ç­¾é¡µ
        function showAnalysisTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            const targetTab = document.getElementById(tabName + '-analysis') || 
                             document.getElementById(tabName + '-detailed-analysis');
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');

            // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½ç›¸åº”æ•°æ®
            switch(tabName) {
                case 'inventory':
                    loadInventoryAnalysis();
                    break;
                case 'customer':
                    loadCustomerAnalysis();
                    break;
                case 'purchase':
                    loadPurchaseAnalysis();
                    break;
            }
        }

        // åŠ è½½åº“å­˜åˆ†æ
        function loadInventoryAnalysis() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            vscode.postMessage({
                command: 'getInventoryAnalysis',
                params: {
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // æ˜¾ç¤ºåº“å­˜åˆ†æç»“æœ
        function displayInventoryAnalysis(data) {
            const summaryDiv = document.getElementById('inventory-summary');
            const deadStockDiv = document.getElementById('dead-stock-table');

            // æ˜¾ç¤ºåº“å­˜æ¦‚è¦
            summaryDiv.innerHTML = `
                <div class="dashboard-grid" style="margin-bottom: 20px;">
                    <div class="metric-card">
                        <h3>ğŸ“Š æ€»ä½“å‘¨è½¬ç‡</h3>
                        <div class="metric-value">${data.overall_turnover_rate || 0}</div>
                        <div class="metric-label">æ¬¡/å¹´</div>
                    </div>
                    <div class="metric-card">
                        <h3>âš¡ å¿«é€Ÿå‘¨è½¬</h3>
                        <div class="metric-value">${data.fast_moving_items || 0}</div>
                        <div class="metric-label">ç§äº§å“</div>
                    </div>
                    <div class="metric-card">
                        <h3>âš ï¸ å‘†æ»åº“å­˜</h3>
                        <div class="metric-value">${data.dead_stock_count || 0}</div>
                        <div class="metric-label">ç§äº§å“</div>
                    </div>
                </div>
            `;

            // æ˜¾ç¤ºå‘†æ»åº“å­˜è¡¨æ ¼
            if (data.dead_stock_items && data.dead_stock_items.length > 0) {
                let tableHtml = `
                    <h4>ğŸš¨ å‘†æ»åº“å­˜è¯¦æƒ…</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>äº§å“åç§°</th>
                                <th>åº“å­˜æ•°é‡</th>
                                <th>åº“å­˜ä»·å€¼</th>
                                <th>å•ä»·</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.dead_stock_items.forEach(item => {
                    tableHtml += `
                        <tr>
                            <td>${item.product_name || 'æœªçŸ¥'}</td>
                            <td>${item.current_stock || 0}</td>
                            <td>${formatCurrency(item.inventory_value || 0)}</td>
                            <td>${formatCurrency(item.unit_price || 0)}</td>
                            <td><span class="status-low">${item.stock_status || 'å‘†æ»'}</span></td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table>';
                deadStockDiv.innerHTML = tableHtml;
            } else {
                deadStockDiv.innerHTML = '<div class="info-message">âœ… æš‚æ— å‘†æ»åº“å­˜</div>';
            }

            // åˆ›å»ºåº“å­˜å‘¨è½¬å›¾è¡¨
            createInventoryChart(data.turnover_analysis || []);
        }

        // åˆ›å»ºåº“å­˜å›¾è¡¨
        function createInventoryChart(data) {
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            
            if (inventoryChart) {
                inventoryChart.destroy();
            }

            // é€‰æ‹©å‰20ä¸ªäº§å“
            const topItems = data.slice(0, 20);
            const labels = topItems.map(item => item.product_name || 'æœªçŸ¥');
            const turnoverRates = topItems.map(item => item.turnover_rate || 0);

            inventoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å‘¨è½¬ç‡',
                        data: turnoverRates,
                        backgroundColor: turnoverRates.map(rate => {
                            if (rate > 4) return '#28a745';
                            if (rate > 2) return '#007bff';
                            if (rate > 0.5) return '#ffc107';
                            return '#dc3545';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å‘¨è½¬ç‡'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            });
        }

        // åŠ è½½å®¢æˆ·åˆ†æ
        function loadCustomerAnalysis() {
            vscode.postMessage({
                command: 'getCustomerAnalysis',
                params: {}
            });
        }

        // æ˜¾ç¤ºå®¢æˆ·åˆ†æç»“æœ
        function displayCustomerAnalysis(data) {
            const summaryDiv = document.getElementById('customer-summary');
            const tableDiv = document.getElementById('customer-table');

            // ç»Ÿè®¡å®¢æˆ·åˆ†ç±»
            const segmentStats = {};
            data.forEach(customer => {
                const segment = customer.customer_segment || 'æœªåˆ†ç±»';
                if (!segmentStats[segment]) {
                    segmentStats[segment] = { count: 0, totalValue: 0 };
                }
                segmentStats[segment].count++;
                segmentStats[segment].totalValue += customer.monetary || 0;
            });

            // æ˜¾ç¤ºå®¢æˆ·åˆ†ç±»æ±‡æ€»
            let summaryHtml = '<div class="dashboard-grid">';
            Object.entries(segmentStats).forEach(([segment, stats]) => {
                summaryHtml += `
                    <div class="metric-card">
                        <h3>${segment}</h3>
                        <div class="metric-value">${stats.count}</div>
                        <div class="metric-label">${formatCurrency(stats.totalValue)}</div>
                    </div>
                `;
            });
            summaryHtml += '</div>';
            summaryDiv.innerHTML = summaryHtml;

            // æ˜¾ç¤ºè¯¦ç»†å®¢æˆ·è¡¨æ ¼
            let tableHtml = `
                <h4>ğŸ† å®¢æˆ·ä»·å€¼æ’è¡Œæ¦œï¼ˆTop 20ï¼‰</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å®¢æˆ·åç§°</th>
                            <th>RFMè¯„åˆ†</th>
                            <th>å®¢æˆ·åˆ†ç±»</th>
                            <th>è´­ä¹°é‡‘é¢</th>
                            <th>è´­ä¹°é¢‘æ¬¡</th>
                            <th>æœ€è¿‘è´­ä¹°</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.slice(0, 20).forEach((customer, index) => {
                const segmentClass = getSegmentClass(customer.customer_segment);
                tableHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${customer.customer_name || 'æœªçŸ¥'}</td>
                        <td><strong>${customer.rfm_score || 0}</strong></td>
                        <td><span class="${segmentClass}">${customer.customer_segment || 'æœªåˆ†ç±»'}</span></td>
                        <td>${formatCurrency(customer.monetary || 0)}</td>
                        <td>${customer.frequency || 0}æ¬¡</td>
                        <td>${customer.recency || 0}å¤©å‰</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            tableDiv.innerHTML = tableHtml;
        }

        // è·å–å®¢æˆ·åˆ†ç±»æ ·å¼ç±»
        function getSegmentClass(segment) {
            const classMap = {
                'å† å†›å®¢æˆ·': 'status-high',
                'å¿ è¯šå®¢æˆ·': 'status-high',
                'æ½œåŠ›å®¢æˆ·': 'status-medium',
                'æ–°å®¢æˆ·': 'status-medium',
                'é£é™©å®¢æˆ·': 'status-low',
                'æµå¤±å®¢æˆ·': 'status-low'
            };
            return classMap[segment] || '';
        }

        // åŠ è½½é‡‡è´­åˆ†æ
        function loadPurchaseAnalysis() {
            showPurchaseTrend('supplier');
        }

        // æ˜¾ç¤ºé‡‡è´­è¶‹åŠ¿
        function showPurchaseTrend(dimension) {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            vscode.postMessage({
                command: 'getPurchaseTrend',
                params: {
                    dimension: dimension,
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // åˆ›å»ºé‡‡è´­è¶‹åŠ¿å›¾è¡¨
        function createPurchaseTrendChart(data, dimension) {
            const ctx = document.getElementById('purchaseTrendChart').getContext('2d');
            
            if (purchaseTrendChart) {
                purchaseTrendChart.destroy();
            }

            let labels, values;
            
            if (dimension === 'supplier') {
                labels = data.slice(0, 10).map(item => item.supplier_name || 'æœªçŸ¥ä¾›åº”å•†');
                values = data.slice(0, 10).map(item => item.total_purchases || 0);
            } else if (dimension === 'material') {
                labels = data.slice(0, 10).map(item => item.material_name || 'æœªçŸ¥ç‰©æ–™');
                values = data.slice(0, 10).map(item => item.total_purchases || 0);
            } else if (dimension === 'month') {
                labels = data.map(item => item.month || item._id);
                values = data.map(item => item.total_purchases || 0);
            }

            purchaseTrendChart = new Chart(ctx, {
                type: dimension === 'month' ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é‡‡è´­é‡‘é¢',
                        data: values,
                        borderColor: '#28a745',
                        backgroundColor: dimension === 'month' ? 'rgba(40, 167, 69, 0.1)' : '#28a745',
                        borderWidth: 2,
                        fill: dimension === 'month'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // ç”Ÿæˆå¯¹æ¯”åˆ†æ
        function generateComparison() {
            const metricsSelect = document.getElementById('comparison-metrics');
            const dimensionsSelect = document.getElementById('comparison-dimensions');
            
            const selectedMetrics = Array.from(metricsSelect.selectedOptions).map(option => option.value);
            const selectedDimensions = Array.from(dimensionsSelect.selectedOptions).map(option => option.value);

            if (selectedMetrics.length === 0 || selectedDimensions.length === 0) {
                showError('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæŒ‡æ ‡å’Œä¸€ä¸ªç»´åº¦');
                return;
            }

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            showLoading('æ­£åœ¨ç”Ÿæˆå¯¹æ¯”åˆ†æ...');

            vscode.postMessage({
                command: 'getComparisonAnalysis',
                params: {
                    metrics: selectedMetrics,
                    dimensions: selectedDimensions,
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // æ˜¾ç¤ºå¯¹æ¯”åˆ†æç»“æœ
        function displayComparisonAnalysis(data) {
            const resultsDiv = document.getElementById('comparison-results');
            
            let html = '<h4>ğŸ“Š å¯¹æ¯”åˆ†æç»“æœ</h4>';
            
            if (data.sales_analysis && data.sales_analysis.length > 0) {
                html += generateComparisonTable('é”€å”®æ•°æ®åˆ†æ', data.sales_analysis);
            }
            
            if (data.purchase_analysis && data.purchase_analysis.length > 0) {
                html += generateComparisonTable('é‡‡è´­æ•°æ®åˆ†æ', data.purchase_analysis);
            }
            
            if (data.inventory_analysis && data.inventory_analysis.length > 0) {
                html += generateComparisonTable('åº“å­˜æ•°æ®åˆ†æ', data.inventory_analysis);
            }

            resultsDiv.innerHTML = html;
        }

        // ç”Ÿæˆå¯¹æ¯”è¡¨æ ¼
        function generateComparisonTable(title, data) {
            if (!data || data.length === 0) return '';
            
            const firstRow = data[0];
            const headers = Object.keys(firstRow._id);
            const metrics = Object.keys(firstRow).filter(key => key !== '_id');

            let html = `<h5>${title}</h5><table class="data-table"><thead><tr>`;
            
            headers.forEach(header => {
                html += `<th>${getHeaderName(header)}</th>`;
            });
            
            metrics.forEach(metric => {
                html += `<th>${getMetricName(metric)}</th>`;
            });
            
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row._id[header] || 'æœªçŸ¥'}</td>`;
                });
                metrics.forEach(metric => {
                    const value = row[metric] || 0;
                    html += `<td>${metric.includes('amount') || metric.includes('value') ? formatCurrency(value) : value.toLocaleString()}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // è·å–è¡¨å¤´åç§°
        function getHeaderName(header) {
            const names = {
                'month': 'æœˆä»½',
                'product': 'äº§å“',
                'customer': 'å®¢æˆ·',
                'supplier': 'ä¾›åº”å•†',
                'material': 'ç‰©æ–™'
            };
            return names[header] || header;
        }

        // è·å–æŒ‡æ ‡åç§°
        function getMetricName(metric) {
            const names = {
                'total_sales': 'é”€å”®æ€»é¢',
                'sales_count': 'é”€å”®ç¬”æ•°',
                'total_purchases': 'é‡‡è´­æ€»é¢',
                'purchase_count': 'é‡‡è´­ç¬”æ•°',
                'inventory_value': 'åº“å­˜ä»·å€¼',
                'stock_quantity': 'åº“å­˜æ•°é‡'
            };
            return names[metric] || metric;
        }

        // å¯¼å‡ºä»ªè¡¨æ¿
        function exportDashboard() {
            vscode.postMessage({
                command: 'exportDashboard',
                params: {
                    start_date: document.getElementById('start-date').value,
                    end_date: document.getElementById('end-date').value
                }
            });
        }

        // æ ¼å¼åŒ–è´§å¸
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return 'Â¥0.00';
            return 'Â¥' + parseFloat(amount).toLocaleString('zh-CN', { minimumFractionDigits: 2 });
        }

        // ç›‘å¬æ¥è‡ªVSCodeçš„æ¶ˆæ¯
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.command) {
                case 'dashboardData':
                    hideLoading();
                    if (message.success) {
                        dashboardData = message.data;
                        generateMetricCards(message.data);
                        
                        // åŠ è½½é”€å”®è¶‹åŠ¿å’Œå®¢æˆ·ä»·å€¼å›¾è¡¨
                        if (message.data.sales_trend) {
                            createSalesTrendChart(message.data.sales_trend, 'month');
                        }
                        if (message.data.top_customers) {
                            createCustomerValueChart(message.data.top_customers);
                        }
                    } else {
                        showError(`åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥: ${message.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    break;

                case 'salesTrendData':
                    hideLoading();
                    if (message.success) {
                        createSalesTrendChart(message.data, message.dimension);
                    } else {
                        showError(`åŠ è½½é”€å”®è¶‹åŠ¿å¤±è´¥: ${message.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    break;

                case 'inventoryAnalysisData':
                    hideLoading();
                    if (message.success) {
                        displayInventoryAnalysis(message.data);
                    } else {
                        showError(`åŠ è½½åº“å­˜åˆ†æå¤±è´¥: ${message.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    break;

                case 'customerAnalysisData':
                    hideLoading();
                    if (message.success) {
                        displayCustomerAnalysis(message.data);
                    } else {
                        showError(`åŠ è½½å®¢æˆ·åˆ†æå¤±è´¥: ${message.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    break;

                case 'purchaseTrendData':
                    hideLoading();
                    if (message.success) {
                        createPurchaseTrendChart(message.data, message.dimension);
                    } else {
                        showError(`åŠ è½½é‡‡è´­è¶‹åŠ¿å¤±è´¥: ${message.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    break;

                case 'comparisonAnalysisData':
                    hideLoading();
                    if (message.success) {
                        displayComparisonAnalysis(message.data);
                    } else {
                        showError(`ç”Ÿæˆå¯¹æ¯”åˆ†æå¤±è´¥: ${message.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    break;

                case 'exportResult':
                    if (message.success) {
                        const successDiv = document.createElement('div');
                        successDiv.className = 'success-message';
                        successDiv.innerHTML = `âœ… ä»ªè¡¨æ¿æŠ¥å‘Šå·²å¯¼å‡º`;
                        document.querySelector('.container').insertBefore(successDiv, document.querySelector('.dashboard-grid'));
                        setTimeout(() => successDiv.remove(), 5000);
                    } else {
                        showError(`å¯¼å‡ºå¤±è´¥: ${message.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    break;

                case 'error':
                    hideLoading();
                    showError(`ç³»ç»Ÿé”™è¯¯: ${message.message}`);
                    break;

                default:
                    console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.command);
                    break;
            }
        });
    </script>
</body>
</html> 