<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†æä»ªè¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        
        .toolbar { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .toolbar-row { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .date-group { display: flex; gap: 15px; align-items: center; }
        .date-group label { font-weight: 500; color: #555; }
        .date-group input { padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #007bff; }
        .metric-card h3 { color: #495057; font-size: 1.1em; margin-bottom: 15px; }
        .metric-value { font-size: 2.5em; font-weight: bold; color: #007bff; margin-bottom: 5px; }
        .metric-label { color: #6c757d; font-size: 0.9em; }
        
        .analysis-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .panel { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .panel-header { background: #f8f9fa; padding: 20px; border-bottom: 1px solid #e9ecef; }
        .panel-header h3 { color: #495057; font-size: 1.2em; }
        .panel-content { padding: 25px; }
        
        .chart-container { height: 300px; position: relative; }
        .chart-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d; font-size: 1.1em; background: #f8f9fa; border-radius: 8px; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .loading-content { background: white; padding: 30px; border-radius: 12px; text-align: center; min-width: 320px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .analysis-panels { grid-template-columns: 1fr; }
            .toolbar-row { flex-direction: column; align-items: stretch; gap: 15px; }
            .chart-container { height: 250px; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ•°æ®åˆ†æä»ªè¡¨æ¿</h1>
            <p>å®æ—¶ä¸šåŠ¡æ´å¯Ÿ | æ™ºèƒ½åˆ†æ | æ•°æ®é©±åŠ¨å†³ç­–</p>
        </div>

        <div class="toolbar">
            <div class="toolbar-row">
                <div class="date-group">
                    <label for="start-date">å¼€å§‹æ—¥æœŸï¼š</label>
                    <input type="date" id="start-date" name="start_date">
                    <label for="end-date">ç»“æŸæ—¥æœŸï¼š</label>
                    <input type="date" id="end-date" name="end_date">
                </div>
                <button class="btn btn-primary" onclick="refreshDashboard()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </div>
        </div>

        <div id="metrics-grid" class="dashboard-grid">
            <!-- åŠ¨æ€ç”Ÿæˆçš„æŒ‡æ ‡å¡ç‰‡ -->
        </div>

        <div class="analysis-panels">
            <div class="panel">
                <div class="panel-header">
                    <h3>ğŸ“ˆ é”€å”®è¶‹åŠ¿åˆ†æ</h3>
                </div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3>ğŸ‘¥ å®¢æˆ·ä»·å€¼åˆ†æ</h3>
                </div>
                <div class="panel-content">
                    <div class="chart-container">
                        <canvas id="customerValueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">æ­£åœ¨åŠ è½½æ•°æ®...</h3>
            <p id="loadingMessage">è¯·ç¨å€™ï¼Œæ­£åœ¨åˆ†ææ‚¨çš„ä¸šåŠ¡æ•°æ®...</p>
        </div>
    </div>

    <script>
        // VS Code API
        const vsCodeApi = (typeof acquireVsCodeApi !== 'undefined') ? acquireVsCodeApi() : {
            postMessage: function(message) {
                console.log('æ¨¡æ‹ŸVS Code APIè°ƒç”¨:', message);
            }
        };
        
        // å…¨å±€å˜é‡
        let dashboardData = null;
        let salesTrendChart = null;
        let customerValueChart = null;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            
            document.getElementById('start-date').value = threeMonthsAgo.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];

            // æ£€æŸ¥æ˜¯å¦åœ¨VS Codeç¯å¢ƒä¸­
            if (typeof acquireVsCodeApi === 'undefined') {
                // æµè§ˆå™¨ç¯å¢ƒï¼ŒåŠ è½½æ¨¡æ‹Ÿæ•°æ®
                loadMockData();
            } else {
                // VS Codeç¯å¢ƒï¼Œè¯·æ±‚çœŸå®æ•°æ®
                refreshDashboard();
            }
        });

        // åŠ è½½æ¨¡æ‹Ÿæ•°æ®ï¼ˆç”¨äºæµè§ˆå™¨é¢„è§ˆï¼‰
        function loadMockData() {
            showLoading('æ­£åœ¨åŠ è½½æ¨¡æ‹Ÿæ•°æ®...', 'å±•ç¤ºä»ªè¡¨æ¿åŠŸèƒ½...');
            
            // æ¨¡æ‹Ÿå»¶è¿Ÿ
            setTimeout(() => {
                const mockData = {
                    overview: {
                        total_sales: 1250000.50,
                        total_sales_count: 342,
                        active_customers: 89,
                        avg_order_value: 3654.68
                    },
                    sales_trend: [
                        { period: '2024-01', total_sales: 180000 },
                        { period: '2024-02', total_sales: 220000 },
                        { period: '2024-03', total_sales: 195000 },
                        { period: '2024-04', total_sales: 240000 },
                        { period: '2024-05', total_sales: 210000 },
                        { period: '2024-06', total_sales: 205000 }
                    ],
                    top_customers: [
                        { customer_name: 'åä¸ºæŠ€æœ¯æœ‰é™å…¬å¸', monetary: 85000 },
                        { customer_name: 'è…¾è®¯ç§‘æŠ€', monetary: 72000 },
                        { customer_name: 'é˜¿é‡Œå·´å·´é›†å›¢', monetary: 68000 },
                        { customer_name: 'ç™¾åº¦åœ¨çº¿', monetary: 55000 },
                        { customer_name: 'äº¬ä¸œé›†å›¢', monetary: 48000 },
                        { customer_name: 'å°ç±³ç§‘æŠ€', monetary: 42000 },
                        { customer_name: 'å­—èŠ‚è·³åŠ¨', monetary: 38000 },
                        { customer_name: 'ç¾å›¢ç‚¹è¯„', monetary: 35000 }
                    ]
                };
                
                handleDashboardData(mockData);
            }, 1500);
        }

        // ç›‘å¬æ¶ˆæ¯
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.command) {
                case 'dashboardData':
                    handleDashboardData(message.data);
                    break;
                case 'error':
                    handleError(message.error);
                    break;
                default:
                    console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.command);
            }
        });

        // åˆ·æ–°ä»ªè¡¨æ¿
        function refreshDashboard() {
            showLoading('æ­£åœ¨åŠ è½½ä»ªè¡¨æ¿æ•°æ®...', 'åˆ†ææ‚¨çš„ä¸šåŠ¡æ•°æ®ï¼Œè¯·ç¨å€™...');
            
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            vsCodeApi.postMessage({
                command: 'getDashboardData',
                params: {
                    start_date: startDate,
                    end_date: endDate
                }
            });
        }

        // å¤„ç†ä»ªè¡¨æ¿æ•°æ®
        function handleDashboardData(response) {
            try {
                console.log('æ”¶åˆ°ä»ªè¡¨æ¿å“åº”:', response);
                
                // éªŒè¯å“åº”æ ¼å¼å¹¶æå–æ•°æ®
                if (response && response.success && response.data) {
                    dashboardData = response.data;
                    console.log('æå–çš„ä»ªè¡¨æ¿æ•°æ®:', dashboardData);
                    
                    // ä½¿ç”¨æå–çš„æ•°æ®ç”ŸæˆæŒ‡æ ‡å¡ç‰‡
                    generateMetricCards(dashboardData);
                    
                    // ç”Ÿæˆæ¨¡æ‹Ÿçš„é”€å”®è¶‹åŠ¿æ•°æ®
                    const mockSalesTrend = generateMockSalesTrend(dashboardData);
                    createSalesTrendChart(mockSalesTrend);
                    
                    // ç”Ÿæˆæ¨¡æ‹Ÿçš„å®¢æˆ·ä»·å€¼æ•°æ®
                    const mockCustomers = generateMockCustomerData(dashboardData);
                    createCustomerValueChart(mockCustomers);
                    
                    hideLoading();
                    console.log('ä»ªè¡¨æ¿æ•°æ®å¤„ç†å®Œæˆ');
                } else {
                     console.error('æ— æ•ˆçš„æ•°æ®æ ¼å¼:', response);
                     hideLoading();
                     showError('æ”¶åˆ°çš„æ•°æ®æ ¼å¼æ— æ•ˆ');
                 }
            } catch (error) {
                console.error('å¤„ç†ä»ªè¡¨æ¿æ•°æ®æ—¶å‡ºé”™:', error);
                hideLoading();
                showError('ä»ªè¡¨æ¿æ•°æ®å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿé”€å”®è¶‹åŠ¿æ•°æ®
        function generateMockSalesTrend(data) {
            const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
            const baseSales = data.total_sales || 0;
            
            return months.map((month, index) => ({
                period: month,
                total_sales: baseSales * (0.8 + Math.random() * 0.4) / 6
            }));
        }
        
        // ç”Ÿæˆæ¨¡æ‹Ÿå®¢æˆ·æ•°æ®
        function generateMockCustomerData(data) {
            const customerNames = ['å®¢æˆ·A', 'å®¢æˆ·B', 'å®¢æˆ·C', 'å®¢æˆ·D', 'å®¢æˆ·E'];
            const totalValue = data.total_sales || 1000;
            
            return customerNames.map((name, index) => ({
                customer_name: name,
                monetary: totalValue * (0.3 - index * 0.05)
            }));
        }

        // ç”Ÿæˆå…³é”®æŒ‡æ ‡å¡ç‰‡
        function generateMetricCards(data) {
            const metricsGrid = document.getElementById('metrics-grid');
            const overview = data || {};

            const metrics = [
                {
                    title: 'æ€»é”€å”®é¢',
                    value: formatCurrency(overview.total_sales || 0),
                    label: 'æœ¬æœŸé”€å”®æ€»é¢',
                    icon: 'ğŸ’°'
                },
                {
                    title: 'åº“å­˜æ€»å€¼',
                    value: formatCurrency(overview.total_inventory_value || 0),
                    label: 'å½“å‰åº“å­˜ä»·å€¼',
                    icon: 'ğŸ“¦'
                },
                {
                    title: 'åº“å­˜å•†å“',
                    value: (overview.total_inventory_items || 0).toLocaleString() + ' ç§',
                    label: 'åº“å­˜å•†å“ç§ç±»',
                    icon: 'ğŸ“‹'
                },
                {
                    title: 'ç¼ºè´§å•†å“',
                    value: (overview.out_of_stock_items || 0).toLocaleString() + ' ç§',
                    label: 'éœ€è¦è¡¥è´§',
                    icon: 'âš ï¸'
                },
                {
                    title: 'æ€»é‡‡è´­é¢',
                    value: formatCurrency(overview.total_purchases || 0),
                    label: 'æœ¬æœŸé‡‡è´­æ€»é¢',
                    icon: 'ğŸ›’'
                },
                {
                    title: 'æ´»è·ƒä¾›åº”å•†',
                    value: (overview.active_suppliers || 0).toLocaleString(),
                    label: 'ä¾›åº”å•†æ•°é‡',
                    icon: 'ğŸ­'
                }
            ];

            let cardsHtml = '';
            metrics.forEach(metric => {
                cardsHtml += `
                    <div class="metric-card">
                        <h3>${metric.icon} ${metric.title}</h3>
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                    </div>
                `;
            });

            metricsGrid.innerHTML = cardsHtml;
        }

        // åˆ›å»ºé”€å”®è¶‹åŠ¿å›¾è¡¨
        function createSalesTrendChart(data) {
            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            
            if (salesTrendChart) {
                salesTrendChart.destroy();
            }

            const labels = data.map(item => item.period || item.month || 'æœªçŸ¥');
            const values = data.map(item => item.total_sales || item.sales || 0);

            salesTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é”€å”®é¢',
                        data: values,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // åˆ›å»ºå®¢æˆ·ä»·å€¼å›¾è¡¨
        function createCustomerValueChart(data) {
            const ctx = document.getElementById('customerValueChart').getContext('2d');
            
            if (customerValueChart) {
                customerValueChart.destroy();
            }

            const labels = data.slice(0, 10).map(item => item.customer_name || 'æœªçŸ¥å®¢æˆ·');
            const values = data.slice(0, 10).map(item => item.monetary || 0);

            customerValueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å®¢æˆ·ä»·å€¼',
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // æ ¼å¼åŒ–è´§å¸
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return 'Â¥0.00';
            return 'Â¥' + parseFloat(amount).toLocaleString('zh-CN', { minimumFractionDigits: 2 });
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(title = 'æ­£åœ¨åŠ è½½...', message = 'è¯·ç¨å€™...') {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            hideLoading();
            alert('é”™è¯¯: ' + message);
        }

        // å¤„ç†é”™è¯¯
        function handleError(error) {
            console.error('å‘ç”Ÿé”™è¯¯:', error);
            showError(error.message || 'æœªçŸ¥é”™è¯¯');
        }
    </script>
</body>
</html>