<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æ–™ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            padding: 8px;
            line-height: 1.2;
            font-size: 9px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 8px;
            padding: 6px;
            background: var(--vscode-panel-background);
            border-radius: 2px;
            border: 1px solid var(--vscode-panel-border);
        }

        .header h1 {
            color: var(--vscode-textLink-foreground);
            margin-bottom: 3px;
            font-size: 12px;
        }

        .header p {
            color: var(--vscode-descriptionForeground);
            font-size: 9px;
        }

        .tabs {
            display: flex;
            margin-bottom: 6px;
            background: var(--vscode-panel-background);
            border-radius: 2px;
            overflow: hidden;
            border: 1px solid var(--vscode-panel-border);
        }

        .tab {
            flex: 1;
            padding: 8px 12px;
            background: var(--vscode-tab-inactiveBackground);
            color: var(--vscode-tab-inactiveForeground);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 9px;
            font-weight: 500;
        }

        .tab:hover {
            background: var(--vscode-tab-hoverBackground);
        }

        .tab.active {
            background: var(--vscode-tab-activeBackground);
            color: var(--vscode-tab-activeForeground);
            border-bottom: 2px solid var(--vscode-textLink-foreground);
        }

        .tab-content {
            display: none;
            background: var(--vscode-panel-background);
            padding: 8px;
            border-radius: 2px;
            border: 1px solid var(--vscode-panel-border);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 6px;
        }

        .form-row {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
        }

        .form-col {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 2px;
            font-weight: 500;
            color: var(--vscode-input-foreground);
            font-size: 9px;
        }

        input, select, textarea {
            width: 100%;
            padding: 6px 8px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 2px;
            font-size: 9px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--vscode-focusBorder);
            box-shadow: 0 0 0 1px var(--vscode-focusBorder);
        }

        .btn {
            padding: 6px 12px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 9px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 6px;
        }

        .btn:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .btn-secondary {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }

        .btn-secondary:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }

        .code-preview {
            background: var(--vscode-textCodeBlock-background);
            padding: 8px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            font-weight: bold;
            color: var(--vscode-textLink-foreground);
            border: 1px solid var(--vscode-panel-border);
            margin: 6px 0;
            text-align: center;
        }

        .encoding-rules {
            background: var(--vscode-textBlockQuote-background);
            padding: 8px;
            border-radius: 2px;
            border-left: 2px solid var(--vscode-textLink-foreground);
            margin: 6px 0;
        }

        .encoding-rules h3 {
            color: var(--vscode-textLink-foreground);
            margin-bottom: 4px;
            font-size: 10px;
        }

        .encoding-rules table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .encoding-rules th,
        .encoding-rules td {
            padding: 3px 6px;
            text-align: left;
            border-bottom: 1px solid var(--vscode-panel-border);
            font-size: 9px;
        }

        .encoding-rules th {
            background: var(--vscode-panel-background);
            font-weight: 600;
        }

        .material-list {
            margin-top: 6px;
        }

        .material-item {
            background: var(--vscode-list-inactiveSelectionBackground);
            padding: 6px;
            margin-bottom: 3px;
            border-radius: 2px;
            border: 1px solid var(--vscode-panel-border);
        }

        .material-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: var(--vscode-textLink-foreground);
            font-size: 10px;
        }

        .material-info {
            margin-top: 2px;
            color: var(--vscode-descriptionForeground);
            font-size: 8px;
        }

        .status-message {
            padding: 4px 6px;
            border-radius: 2px;
            margin: 4px 0;
            font-weight: 500;
            font-size: 9px;
        }

        .status-success {
            background: var(--vscode-testing-iconPassed);
            color: white;
        }

        .status-error {
            background: var(--vscode-testing-iconFailed);
            color: white;
        }

        .status-warning {
            background: var(--vscode-testing-iconQueued);
            color: white;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid var(--vscode-panel-border);
            border-top: 3px solid var(--vscode-textLink-foreground);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ ç‰©æ–™ç®¡ç†ç³»ç»Ÿ</h1>
            <p>æ ‡å‡†åŒ–ç‰©æ–™ç¼–ç ç®¡ç† | ç¬¦åˆ P-12-03-0000-001 è§„èŒƒ</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab(event, 'add-material')">â• æ–°å¢ç‰©æ–™</button>
            <button class="tab" onclick="showTab(event, 'material-list')">ğŸ“‹ ç‰©æ–™åˆ—è¡¨</button>
            <button class="tab" onclick="showTab(event, 'encoding-rules')">ğŸ“– ç¼–ç è§„åˆ™</button>
            <button class="tab" onclick="showTab(event, 'supplier-codes')">ğŸ¢ ä¾›åº”å•†ç¼–ç </button>
        </div>

        <!-- æ–°å¢ç‰©æ–™ -->
        <div id="add-material" class="tab-content active">
            <form id="materialForm">
                <div class="form-row">
                    <div class="form-col">
                        <label for="platform">ç‰©æ–™å¹³å° *</label>
                        <select id="platform" name="platform" required onchange="updateCodePreview()">
                            <option value="">è¯·é€‰æ‹©å¹³å°</option>
                            <option value="P">P - é‡‡è´­ç‰©æ–™</option>
                            <option value="R">R - è‡ªç ”ç‰©æ–™</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="type1">ç‰©æ–™ç±»å‹2 *</label>
                        <select id="type1" name="type1" required onchange="updateCodePreview()">
                            <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                            <option value="1">1 - å›½äº§</option>
                            <option value="2">2 - éå›½äº§</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label for="type2">ç‰©æ–™ç±»å‹3 *</label>
                        <select id="type2" name="type2" required onchange="updateCodePreview()">
                            <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                            <option value="1">1 - çº¯è½¯ä»¶</option>
                            <option value="2">2 - æœåŠ¡å™¨(ç¡¬ä»¶)</option>
                            <option value="3">3 - å·¥æ§æœº(ç¡¬ä»¶)</option>
                            <option value="4">4 - é…ä»¶</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="supplier">ä¾›åº”å•† *</label>
                        <select id="supplier" name="supplier" required onchange="updateCodePreview()">
                            <option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>
                            <!-- ä¾›åº”å•†é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </select>
                    </div>
                </div>

                <div class="code-preview" id="codePreview">
                    ç‰©æ–™ç¼–ç é¢„è§ˆ: è¯·å¡«å†™ä¸Šè¿°ä¿¡æ¯
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label for="materialName">ç‰©æ–™åç§° *</label>
                        <input type="text" id="materialName" name="materialName" required 
                               placeholder="ä¾‹å¦‚: å·¥æ§æœº">
                    </div>
                    <div class="form-col">
                        <label for="materialModel">ç‰©æ–™å‹å· *</label>
                        <input type="text" id="materialModel" name="materialModel" required 
                               placeholder="ä¾‹å¦‚: 1U-C3558-4ç”µ2å…‰-128G MSATAç›˜-å•ç”µæº">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label for="hardwarePlatform">ç¡¬ä»¶å¹³å°</label>
                        <input type="text" id="hardwarePlatform" name="hardwarePlatform" 
                               placeholder="ä¾‹å¦‚: x86, ARM, é€šç”¨">
                    </div>
                    <div class="form-col">
                        <label for="unit">å•ä½ *</label>
                        <select id="unit" name="unit" required>
                            <option value="å°">å°</option>
                            <option value="ä¸ª">ä¸ª</option>
                            <option value="å¥—">å¥—</option>
                            <option value="å¼ ">å¼ </option>
                            <option value="å—">å—</option>
                            <option value="æ¡">æ¡</option>
                            <option value="æ ¹">æ ¹</option>
                            <option value="ç‰‡">ç‰‡</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn">ğŸ’¾ æ·»åŠ ç‰©æ–™</button>
                    <button type="reset" class="btn btn-secondary" onclick="resetForm()">ğŸ”„ é‡ç½®è¡¨å•</button>
                </div>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æ·»åŠ ç‰©æ–™...</p>
            </div>

            <div id="statusMessage"></div>
        </div>

        <!-- ç‰©æ–™åˆ—è¡¨ -->
        <div id="material-list" class="tab-content">
            <div class="form-group">
                <button class="btn" onclick="loadMaterialList()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                <button class="btn btn-secondary" onclick="exportMaterialList()">ğŸ“¤ å¯¼å‡ºåˆ—è¡¨</button>
            </div>
            <div id="materialListContainer">
                <p>ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"åŠ è½½ç‰©æ–™æ•°æ®</p>
            </div>
        </div>

        <!-- ç¼–ç è§„åˆ™ -->
        <div id="encoding-rules" class="tab-content">
            <div class="encoding-rules">
                <h3>ğŸ“‹ ç¼–ç æ ¼å¼è¯´æ˜</h3>
                <p><strong>æ ‡å‡†æ ¼å¼:</strong> <code>P-12-03-0000-001</code></p>
                <p>ç¼–ç ç”±5ä¸ªéƒ¨åˆ†ç»„æˆï¼Œç”¨çŸ­æ¨ªçº¿åˆ†éš”:</p>
                
                <table>
                    <thead>
                        <tr>
                            <th>ä½ç½®</th>
                            <th>å«ä¹‰</th>
                            <th>å–å€¼èŒƒå›´</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ç¬¬1ä½</td>
                            <td>ç‰©æ–™å¹³å°</td>
                            <td>P, R</td>
                            <td>P=é‡‡è´­ç‰©æ–™, R=è‡ªç ”ç‰©æ–™</td>
                        </tr>
                        <tr>
                            <td>ç¬¬2ä½</td>
                            <td>ç‰©æ–™ç±»å‹2</td>
                            <td>1, 2</td>
                            <td>1=å›½äº§, 2=éå›½äº§</td>
                        </tr>
                        <tr>
                            <td>ç¬¬3ä½</td>
                            <td>ç‰©æ–™ç±»å‹3</td>
                            <td>1-4</td>
                            <td>1=çº¯è½¯ä»¶, 2=æœåŠ¡å™¨, 3=å·¥æ§æœº, 4=é…ä»¶</td>
                        </tr>
                        <tr>
                            <td>ç¬¬4-5ä½</td>
                            <td>ä¾›åº”å•†ç¼–ç </td>
                            <td>01-99</td>
                            <td>åœ¨ä¾›åº”å•†åˆ—è¡¨ä¸­é¢„å®šä¹‰</td>
                        </tr>
                        <tr>
                            <td>ç¬¬6-9ä½</td>
                            <td>ä¿ç•™ä½</td>
                            <td>0000</td>
                            <td>å›ºå®šå€¼ï¼Œé¢„ç•™æ‰©å±•</td>
                        </tr>
                        <tr>
                            <td>ç¬¬10-12ä½</td>
                            <td>ç‰©æ–™åºå·</td>
                            <td>001-999</td>
                            <td>åŒç±»åˆ«ä¸‹é€’å¢åºå·</td>
                        </tr>
                    </tbody>
                </table>

                <h3>ğŸ”¢ ç¼–ç ç¤ºä¾‹</h3>
                <ul>
                    <li><code>P-13-05-0000-001</code> - é‡‡è´­çš„å›½äº§å·¥æ§æœºï¼Œä¾›åº”å•†05ï¼Œåºå·001</li>
                    <li><code>P-24-05-0000-001</code> - é‡‡è´­çš„éå›½äº§é…ä»¶ï¼Œä¾›åº”å•†05ï¼Œåºå·001</li>
                    <li><code>R-11-05-0000-001</code> - è‡ªç ”çš„å›½äº§è½¯ä»¶ï¼Œä¾›åº”å•†05ï¼Œåºå·001</li>
                </ul>
            </div>
        </div>

        <!-- ä¾›åº”å•†ç¼–ç  -->
        <div id="supplier-codes" class="tab-content">
            <div class="form-group">
                <button class="btn" onclick="loadSupplierCodes()">ğŸ”„ åˆ·æ–°ç¼–ç </button>
                <button class="btn btn-secondary" onclick="assignSupplierCodes()">ğŸ·ï¸ åˆ†é…ç¼–ç </button>
            </div>
            <div id="supplierCodesContainer">
                <p>ç‚¹å‡»"åˆ·æ–°ç¼–ç "åŠ è½½ä¾›åº”å•†ç¼–ç æ•°æ®</p>
            </div>
        </div>
    </div>

    <script>
        // VSCode API
        const vscode = acquireVsCodeApi();

        // å½“å‰é€‰ä¸­çš„ä¾›åº”å•†ä¿¡æ¯
        let suppliers = [];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSuppliers();
            setupFormSubmission();
        });

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(event, tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾
            if(event.target) {
                event.target.classList.add('active');
            }
        }

        // åŠ è½½ä¾›åº”å•†åˆ—è¡¨
        function loadSuppliers() {
            vscode.postMessage({
                command: 'loadSuppliers'
            });
        }

        // æ›´æ–°ç¼–ç é¢„è§ˆ
        function updateCodePreview() {
            const platform = document.getElementById('platform').value;
            const type1 = document.getElementById('type1').value;
            const type2 = document.getElementById('type2').value;
            const supplierSelect = document.getElementById('supplier');
            const supplierCode = supplierSelect.value;
            
            const preview = document.getElementById('codePreview');
            
            if (platform && type1 && type2 && supplierCode) {
                const code = `${platform}-${type1}${type2}-${supplierCode}-0000-XXX`;
                preview.textContent = `ç‰©æ–™ç¼–ç é¢„è§ˆ: ${code}`;
                preview.style.color = 'var(--vscode-textLink-foreground)';
            } else {
                preview.textContent = 'ç‰©æ–™ç¼–ç é¢„è§ˆ: è¯·å¡«å†™ä¸Šè¿°ä¿¡æ¯';
                preview.style.color = 'var(--vscode-descriptionForeground)';
            }
        }

        // è®¾ç½®è¡¨å•æäº¤
        function setupFormSubmission() {
            document.getElementById('materialForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const materialData = {
                    platform: formData.get('platform'),
                    type1: formData.get('type1'),
                    type2: formData.get('type2'),
                    supplier_code: formData.get('supplier'),
                    supplier_name: getSupplierName(formData.get('supplier')),
                    material_name: formData.get('materialName'),
                    material_model: formData.get('materialModel'),
                    hardware_platform: formData.get('hardwarePlatform') || '',
                    unit: formData.get('unit')
                };
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('loading').style.display = 'block';
                document.getElementById('statusMessage').innerHTML = '';
                
                // å‘é€åˆ°åç«¯
                vscode.postMessage({
                    command: 'addMaterial',
                    data: materialData
                });
            });
        }

        // è·å–ä¾›åº”å•†åç§°
        function getSupplierName(supplierCode) {
            const supplier = suppliers.find(s => s.supplier_code === supplierCode);
            return supplier ? supplier.supplier_name : '';
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('materialForm').reset();
            updateCodePreview();
            document.getElementById('statusMessage').innerHTML = '';
        }

        // åŠ è½½ç‰©æ–™åˆ—è¡¨
        function loadMaterialList() {
            vscode.postMessage({
                command: 'loadMaterials'
            });
        }

        // å¯¼å‡ºç‰©æ–™åˆ—è¡¨
        function exportMaterialList() {
            vscode.postMessage({
                command: 'exportMaterials'
            });
        }

        // åŠ è½½ä¾›åº”å•†ç¼–ç 
        function loadSupplierCodes() {
            vscode.postMessage({
                command: 'loadSupplierCodes'
            });
        }

        // åˆ†é…ä¾›åº”å•†ç¼–ç 
        function assignSupplierCodes() {
            vscode.postMessage({
                command: 'assignSupplierCodes'
            });
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            // éšè—åŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'none';
        }

        // ç›‘å¬æ¥è‡ªVSCodeçš„æ¶ˆæ¯
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.command) {
                case 'suppliersLoaded':
                    suppliers = message.data;
                    updateSupplierSelect(message.data);
                    break;
                    
                case 'materialAdded':
                    if (message.success) {
                        showStatus(`âœ… ç‰©æ–™æ·»åŠ æˆåŠŸï¼ç¼–ç : ${message.materialCode}`, 'success');
                        resetForm();
                    } else {
                        showStatus(`âŒ æ·»åŠ å¤±è´¥: ${message.error}`, 'error');
                    }
                    break;
                    
                case 'materialsLoaded':
                    updateMaterialList(message.data);
                    break;
                    
                case 'supplierCodesLoaded':
                    updateSupplierCodesList(message.data);
                    break;
                    
                case 'error':
                    showStatus(`âŒ é”™è¯¯: ${message.message}`, 'error');
                    break;
            }
        });

        // æ›´æ–°ä¾›åº”å•†ä¸‹æ‹‰åˆ—è¡¨
        function updateSupplierSelect(supplierData) {
            const select = document.getElementById('supplier');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>';
            
            supplierData.forEach(supplier => {
                if (supplier.supplier_code) {
                    const option = document.createElement('option');
                    option.value = supplier.supplier_code;
                    option.textContent = `${supplier.supplier_code} - ${supplier.supplier_name}`;
                    select.appendChild(option);
                }
            });
        }

        // æ›´æ–°ç‰©æ–™åˆ—è¡¨
        function updateMaterialList(materials) {
            const container = document.getElementById('materialListContainer');
            
            if (!materials || materials.length === 0) {
                container.innerHTML = '<p>æš‚æ— ç‰©æ–™æ•°æ®</p>';
                return;
            }
            
            let html = '<div class="material-list">';
            materials.forEach(material => {
                html += `
                    <div class="material-item">
                        <div class="material-code">${material.material_code}</div>
                        <div class="material-info">
                            <strong>${material.material_name}</strong> - ${material.material_model}<br>
                            ä¾›åº”å•†: ${material.supplier_name || 'æœªçŸ¥'} | å•ä½: ${material.unit} | å¹³å°: ${material.platform || '--'}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // æ›´æ–°ä¾›åº”å•†ç¼–ç åˆ—è¡¨
        function updateSupplierCodesList(suppliers) {
            const container = document.getElementById('supplierCodesContainer');
            
            if (!suppliers || suppliers.length === 0) {
                container.innerHTML = '<p>æš‚æ— ä¾›åº”å•†ç¼–ç æ•°æ®</p>';
                return;
            }
            
            let html = '<div class="material-list">';
            suppliers.forEach(supplier => {
                const code = supplier.supplier_code || '--';
                const name = supplier.supplier_name || 'æœªçŸ¥ä¾›åº”å•†';
                html += `
                    <div class="material-item">
                        <div class="material-code">${code}</div>
                        <div class="material-info">${name}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>