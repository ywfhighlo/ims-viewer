<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户管理</title>
    <style>
        :root {
            --vscode-foreground: #cccccc;
            --vscode-background: #1e1e1e;
            --vscode-input-background: #3c3c3c;
            --vscode-button-background: #0e639c;
            --vscode-button-hoverBackground: #1177bb;
            --vscode-border-color: #3c3c3c;
        }
        body { font-family: sans-serif; color: var(--vscode-foreground); background-color: var(--vscode-background); padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; }
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .toolbar input { background-color: var(--vscode-input-background); color: var(--vscode-foreground); border: 1px solid var(--vscode-border-color); padding: 8px; border-radius: 4px; }
        .toolbar button { background-color: var(--vscode-button-background); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .toolbar button:hover { background-color: var(--vscode-button-hoverBackground); }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--vscode-border-color); padding: 10px; text-align: left; }
        th { background-color: var(--vscode-input-background); }
        .actions button { margin-right: 5px; }
        .pagination { text-align: center; margin-top: 20px; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--vscode-background); margin: 10% auto; padding: 20px; border: 1px solid var(--vscode-border-color); width: 80%; max-width: 500px; border-radius: 5px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 95%; padding: 8px; background-color: var(--vscode-input-background); color: var(--vscode-foreground); border: 1px solid var(--vscode-border-color); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>客户管理</h1>
        <div class="toolbar">
            <button id="add-customer-btn">添加新客户</button>
            <div>
                <input type="text" id="search-input" placeholder="搜索客户...">
                <button id="search-btn">搜索</button>
            </div>
        </div>
        <table id="customer-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-checkbox"></th>
                    <th>客户名称</th>
                    <th>联系人</th>
                    <th>电话</th>
                    <th>地址</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="pagination" id="pagination-controls"></div>
        <button id="batch-delete-btn">批量删除</button>
    </div>

    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">添加客户</h2>
                <span class="close">&times;</span>
            </div>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="form-group">
                    <label for="customer_name">客户名称</label>
                    <input type="text" id="customer_name" required>
                </div>
                <div class="form-group">
                    <label for="customer_contact">联系人</label>
                    <input type="text" id="customer_contact">
                </div>
                <div class="form-group">
                    <label for="customer_phone">联系电话</label>
                    <input type="text" id="customer_phone">
                </div>
                <div class="form-group">
                    <label for="customer_address">地址</label>
                    <input type="text" id="customer_address">
                </div>
                <button type="submit">保存</button>
            </form>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let currentPage = 1;
        let currentSearch = '';

        const tableBody = document.querySelector('#customer-table tbody');
        const paginationControls = document.getElementById('pagination-controls');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const addCustomerBtn = document.getElementById('add-customer-btn');
        const batchDeleteBtn = document.getElementById('batch-delete-btn');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');

        const modal = document.getElementById('customer-modal');
        const modalTitle = document.getElementById('modal-title');
        const customerForm = document.getElementById('customer-form');
        const customerIdInput = document.getElementById('customer-id');
        const closeModalBtn = document.querySelector('.modal .close');

        function loadCustomers(page = 1, searchQuery = '') {
            currentPage = page;
            currentSearch = searchQuery;
            vscode.postMessage({ command: 'loadCustomers', data: { page, limit: 10, search_query: searchQuery } });
        }

        function renderTable(customers) {
            tableBody.innerHTML = '';
            if (!customers || customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">没有数据</td></tr>';
                return;
            }
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" data-id="${customer._id}"></td>
                    <td>${customer.customer_name || ''}</td>
                    <td>${customer.customer_contact || ''}</td>
                    <td>${customer.customer_phone || ''}</td>
                    <td>${customer.customer_address || ''}</td>
                    <td class="actions">
                        <button class="edit-btn" data-id='${JSON.stringify(customer)}'>编辑</button>
                        <button class="delete-btn" data-id="${customer._id}">删除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderPagination(totalPages, currentPage) {
            paginationControls.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                if (i === currentPage) {
                    pageBtn.disabled = true;
                }
                pageBtn.addEventListener('click', () => loadCustomers(i, currentSearch));
                paginationControls.appendChild(pageBtn);
            }
        }

        function openModal(customer = null) {
            customerForm.reset();
            if (customer) {
                modalTitle.textContent = '编辑客户';
                customerIdInput.value = customer._id;
                document.getElementById('customer_name').value = customer.customer_name || '';
                document.getElementById('customer_contact').value = customer.customer_contact || '';
                document.getElementById('customer_phone').value = customer.customer_phone || '';
                document.getElementById('customer_address').value = customer.customer_address || '';
            } else {
                modalTitle.textContent = '添加客户';
                customerIdInput.value = '';
            }
            modal.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        addCustomerBtn.addEventListener('click', () => openModal());
        closeModalBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                closeModal();
            }
        });

        customerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = customerIdInput.value;
            const customerData = {
                customer_name: document.getElementById('customer_name').value,
                customer_contact: document.getElementById('customer_contact').value,
                customer_phone: document.getElementById('customer_phone').value,
                customer_address: document.getElementById('customer_address').value,
            };
            if (id) {
                customerData._id = id;
                vscode.postMessage({ command: 'updateCustomer', data: customerData });
            } else {
                vscode.postMessage({ command: 'addCustomer', data: customerData });
            }
            closeModal();
        });

        tableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const customer = JSON.parse(e.target.dataset.id);
                openModal(customer);
            } else if (e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                vscode.postMessage({ command: 'deleteCustomer', data: { _id: id } });
            }
        });

        searchBtn.addEventListener('click', () => {
            loadCustomers(1, searchInput.value);
        });
        
        selectAllCheckbox.addEventListener('change', (e) => {
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        batchDeleteBtn.addEventListener('click', () => {
            const selectedIds = [];
            document.querySelectorAll('.row-checkbox:checked').forEach(checkbox => {
                selectedIds.push(checkbox.dataset.id);
            });
            if (selectedIds.length > 0) {
                vscode.postMessage({ command: 'batchDeleteCustomers', data: { ids: selectedIds } });
            } else {
                alert('请先选择要删除的客户');
            }
        });

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'customersLoaded':
                    if (message.success) {
                        renderTable(message.data.records);
                        renderPagination(message.data.total_pages, message.data.page);
                    } else {
                        tableBody.innerHTML = `<tr><td colspan="6">Error: ${message.message}</td></tr>`;
                    }
                    break;
                case 'customerAdded':
                case 'customerUpdated':
                case 'customerDeleted':
                case 'customersBatchDeleted':
                    if (!message.success) {
                        alert(`Error: ${message.message}`);
                    }
                    // Reload is handled by the provider
                    break;
            }
        });

        // Initial load
        loadCustomers();
    </script>
</body>
</html>
